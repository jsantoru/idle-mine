<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Idle Mining Tycoon ‚Äî Visuals Prototype (No Build)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f12; --panel: #17191f; --accent: #4fd36a; --accent-2: #5bb7ff;
      --text: #e8e8ee; --muted: #a7a7b7; --danger: #ff6b6b; --warn: #ffd36b;
      --border: #2a2e36; --card: #14171d;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body { margin: 0; background: linear-gradient(180deg,#0e1015,#0b0d12 220px) fixed;
      color: var(--text); font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; -webkit-font-smoothing: antialiased;
    }
    #hud { position: fixed; left:0; right:0; top:0; display:flex; gap:.75rem; align-items:center; flex-wrap:wrap;
      padding:.6rem .75rem; background: rgba(0,0,0,.35); backdrop-filter: blur(4px); border-bottom:1px solid var(--border); z-index:10; font-weight:600; }
    #hud .pill { background: var(--panel); border: 1px solid var(--border); padding:.35rem .6rem; border-radius:.6rem; display:flex; gap:.4rem; align-items:center; }

    #main { padding-top: 56px; padding-bottom: 62px; }
    #scene { display:block; width:100%; height: 280px; border-bottom:1px solid var(--border); background: #0c0f14; }

    .tabbar { position:fixed; left:0; right:0; bottom:0; z-index:10; background:#0b0d12; border-top:1px solid var(--border); display:grid; grid-template-columns: repeat(6, 1fr); gap:.25rem; padding:.35rem; }
    .tabbar button { background: var(--panel); color: var(--text); border:1px solid var(--border); padding:.6rem .4rem; border-radius:.6rem; font-weight:600; cursor:pointer; }
    .tabbar button.active { outline: 2px solid var(--accent); }

    .panel { position:fixed; left:.6rem; right:.6rem; bottom:3.2rem; top: calc(280px + 56px + .6rem);
      background: var(--panel); border:1px solid var(--border); border-radius:.8rem; padding:.8rem; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.35); }

    h2, h3 { margin:.2rem 0 .6rem }
    .row { display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:.8rem; padding:.8rem; margin-bottom:.6rem; }
    .small { color: var(--muted); font-size:.9rem }
    button { background:#1a1f26; color:var(--text); border:1px solid var(--border); padding:.5rem .75rem; border-radius:.6rem; cursor:pointer; font-weight:600; }
    button.primary { background:#1a2520; border-color:#1f3d2a; color:#dfffe9 }
    button:disabled { opacity:.55; cursor:not-allowed }
    progress { width:100%; height:10px; }
    .kpi { font-weight:700; color:var(--accent) }
    .accent { color:var(--accent) }
    .accent2 { color:var(--accent-2) }
    .danger { color:var(--danger) }
    .warn { color:var(--warn) }
    .grid { display:grid; gap:.6rem }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    @media (max-width: 720px) { .grid.cols-2 { grid-template-columns: 1fr } }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:20; }
    .modal { width:min(720px, 96vw); background:var(--panel); border:1px solid var(--border); border-radius:.8rem; padding:1rem; box-shadow:0 20px 60px rgba(0,0,0,.5); }
    .modal h3 { margin-top:0 }
    .right { margin-left:auto }
    .bar { height:10px; background:#0e1117; border:1px solid var(--border); border-radius:4px; overflow:hidden; }
    .bar > i { display:block; height:100%; background: linear-gradient(90deg, var(--accent), #7be495); width:0%; }
    .muted { color: var(--muted) }
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    <div class="pill">üí∞ Coins: <span id="coins">0</span></div>
    <div class="pill">üß∞ Blueprints: <span id="blueprints">0</span></div>
    <div class="pill">‚õèÔ∏è Stone: <span id="stoneInv">0</span>/<span id="cap">200</span></div>
    <div class="pill">‚ö° Rate: <span id="stoneRate">0</span>/s</div>
    <div class="pill small">üïí Autosave</div>
  </div>

  <div id="main">
    <canvas id="scene" width="600" height="280" aria-label="Mining scene"></canvas>
  </div>

  <!-- Panel (content swaps via tabs) -->
  <div id="panel" class="panel" hidden></div>

  <!-- Tabs -->
  <div class="tabbar">
    <button data-tab="stations" class="active">Stations</button>
    <button data-tab="upgrades">Upgrades</button>
    <button data-tab="workers">Workers</button>
    <button data-tab="contracts">Contracts</button>
    <button data-tab="stats">Stats</button>
    <button data-tab="settings">Settings</button>
  </div>

  <!-- Offline modal -->
  <div id="modalWrap" class="modal-backdrop">
    <div class="modal">
      <h3>‚õèÔ∏è Offline Progress</h3>
      <div id="offlineDetails" class="small"></div>
      <div class="row" style="margin-top:.6rem">
        <button id="closeModal" class="primary right">Continue</button>
      </div>
    </div>
  </div>

  <!-- Contracts config (inline JSON) -->
  <script type="application/json" id="cfg-contracts">
  {
    "offers": [
      { "id": "c-stone-100", "demand": [{"res":"stone","qty":100}], "durationSec": 300, "payout": 180, "rushBonus": 0.20, "penalty": 0.10 },
      { "id": "c-stone-200", "demand": [{"res":"stone","qty":200}], "durationSec": 420, "payout": 360, "rushBonus": 0.20, "penalty": 0.10 }
    ]
  }
  </script>

  <script>
  (function(){
    // ---------- Utilities
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const nowMs = () => Date.now();
    const fmtInt = n => Math.floor(n).toLocaleString();
    const money = n => fmtInt(n);
    const el = id => document.getElementById(id);

    // ---------- Tuning
    const TUNE = {
      baseStoneRate: 1.0,              // items/sec
      minerAddPerLevel: 0.05,          // +5% per miner level
      drillPowerMult: 1.15,            // per upgrade level
      drillPowerCostBase: 50, drillPowerCostRate: 1.18,

      warehouseBase: 200, warehouseStep: 50,
      warehouseCostBase: 80, warehouseCostRate: 1.17,

      sellPrice: { stone: 1 },

      autosaveMs: 10_000,
      offlineMult: 0.20,               // 20% of online rate
      offlineCapSec: 20 * 60,          // 20 minutes cap for MVP
      version: 2
    };

    // ---------- State
    const state = {
      version: TUNE.version,
      coins: 0,
      blueprints: 0,
      inv: { stone: 0 },
      upgrades: { drill_power: 0, warehouse_size: 0 },
      workers: { miner: 0 },
      lastTickMs: nowMs(),
      producedLastTick: 0,
      contract: null,
      options: { autoSellAtCap: false }
    };

    // ---------- Persistence
    const SAVE_KEY = 'imt_proto_save_v2';
    function save() {
      const data = {
        version: state.version, coins: state.coins, blueprints: state.blueprints,
        inv: state.inv, upgrades: state.upgrades, workers: state.workers,
        contract: state.contract ? {
          offer: state.contract.offer, acceptedAtMs: state.contract.acceptedAtMs,
          deadlineMs: state.contract.deadlineMs, delivered: state.contract.delivered,
          done: state.contract.done, failed: state.contract.failed
        } : null,
        options: state.options, lastActiveMs: nowMs()
      };
      try { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); } catch {}
    }
    function load() {
      const raw = localStorage.getItem(SAVE_KEY);
      if (!raw) return null; try { return JSON.parse(raw); } catch { return null; }
    }
    function applyLoad(s) {
      if (!s) return;
      state.version = s.version ?? state.version;
      state.coins = s.coins ?? 0; state.blueprints = s.blueprints ?? 0;
      state.inv = Object.assign({stone:0}, s.inv||{});
      state.upgrades = Object.assign({drill_power:0, warehouse_size:0}, s.upgrades||{});
      state.workers = Object.assign({miner:0}, s.workers||{});
      state.contract = s.contract || null; state.options = Object.assign({autoSellAtCap:false}, s.options||{});
      const last = s.lastActiveMs || nowMs(); const elapsedSec = Math.max(0, Math.floor((nowMs()-last)/1000));
      if (elapsedSec>3) { const considered=Math.min(elapsedSec, TUNE.offlineCapSec); const rate=computeStoneRate();
        const before=state.inv.stone; addToInventory('stone', rate*considered*TUNE.offlineMult); const after=state.inv.stone;
        showOfflineModal({elapsedSec, considered, produced: after-before, rate}); }
    }

    // ---------- Rates / Capacity
    function computeWarehouseCap(){ return TUNE.warehouseBase + state.upgrades.warehouse_size*TUNE.warehouseStep; }
    function computeStoneRate(){
      const multFromDrill = Math.pow(TUNE.drillPowerMult, state.upgrades.drill_power);
      const minerMult = 1 + (state.workers.miner * TUNE.minerAddPerLevel);
      return TUNE.baseStoneRate * multFromDrill * minerMult;
    }
    function inventoryTotal(){ return state.inv.stone; }
    function addToInventory(res, qty){ if(qty<=0) return 0; const cap=computeWarehouseCap(); const room=Math.max(0, cap-inventoryTotal()); const add=Math.min(room, qty); state.inv[res]=(state.inv[res]||0)+add; return add; }

    // ---------- Economy helpers
    const costGeom=(base,rate,lvl)=>Math.floor(base*Math.pow(rate,lvl));
    function buyDrillPower(){ const c=costGeom(TUNE.drillPowerCostBase,TUNE.drillPowerCostRate,state.upgrades.drill_power); if(state.coins>=c){ state.coins-=c; state.upgrades.drill_power++; renderIfTab('upgrades'); }}
    function buyWarehouseSize(){ const c=costGeom(TUNE.warehouseCostBase,TUNE.warehouseCostRate,state.upgrades.warehouse_size); if(state.coins>=c){ state.coins-=c; state.upgrades.warehouse_size++; renderIfTab('upgrades'); }}
    function hireMiner(){ const base=60, rate=1.25, lvl=state.workers.miner; const c=costGeom(base,rate,lvl); if(state.coins>=c){ state.coins-=c; state.workers.miner++; renderIfTab('workers'); }}

    // ---------- Selling
    function sell(res,qty){ const have=Math.floor(state.inv[res]||0); const sellQty=Math.max(0,Math.min(have,qty)); if(sellQty<=0) return 0; state.inv[res]-=sellQty; const gain=sellQty*(TUNE.sellPrice[res]||0); state.coins+=gain; return sellQty; }
    function sellAll(res){ const qty=Math.floor(state.inv[res]||0); return sell(res, qty); }

    // ---------- Contracts
    const CONTRACT_OFFERS = JSON.parse(document.getElementById('cfg-contracts').textContent).offers; let rotatingOfferIdx=0;
    function getNextOffer(){ const offer=CONTRACT_OFFERS[rotatingOfferIdx % CONTRACT_OFFERS.length]; rotatingOfferIdx++; return JSON.parse(JSON.stringify(offer)); }
    function acceptOffer(offer){ if(state.contract && !state.contract.done && !state.contract.failed) return; const now=nowMs(); state.contract={ offer, acceptedAtMs: now, deadlineMs: now + offer.durationSec*1000, delivered:0, done:false, failed:false }; renderIfTab('contracts'); }
    function tickContract(dt){ if(!state.contract || state.contract.done || state.contract.failed) return; const c=state.contract, o=c.offer; const need=o.demand[0].qty - c.delivered; if(need>0){ const deliverNow=Math.min(need, Math.floor(state.inv[o.demand[0].res]||0)); if(deliverNow>0){ state.inv[o.demand[0].res]-=deliverNow; c.delivered+=deliverNow; } }
      if(c.delivered>=o.demand[0].qty){ const now=nowMs(); const total=o.durationSec*1000; const left=Math.max(0, c.deadlineMs-now); const leftPct=left/total; const bonus= leftPct>=0.25 ? o.rushBonus : 0; const payout = o.payout*(1+bonus); state.coins+=payout; c.done=true; }
      else if(nowMs()>=c.deadlineMs){ const penalty=Math.floor(o.payout*o.penalty); state.coins=Math.max(0, state.coins - penalty); c.failed=true; }
    }

    // ---------- Ticker (game logic)
    function tick(dt){
      const produced = computeStoneRate() * dt; // produced this frame
      state.producedLastTick = addToInventory('stone', produced);
      if(state.options.autoSellAtCap){ const cap=computeWarehouseCap(); if(inventoryTotal()>=cap) sellAll('stone'); }
      tickContract(dt);
    }

    // ---------- UI
    const panel = el('panel'); let currentTab='stations';
    function setTab(name){ currentTab=name; document.querySelectorAll('.tabbar button').forEach(b=>b.classList.toggle('active', b.dataset.tab===name)); panel.hidden=false; ({ stations: renderStations, upgrades: renderUpgrades, workers: renderWorkers, contracts: renderContracts, stats: renderStats, settings: renderSettings }[name]||renderStations)(); }
    function renderIfTab(name){ if(currentTab===name) ({ stations: renderStations, upgrades: renderUpgrades, workers: renderWorkers, contracts: renderContracts, stats: renderStats, settings: renderSettings }[name]()) }
    function bar(percent){ percent=clamp(percent,0,100); return `<div class="bar"><i style="width:${percent}%"></i></div>`; }
    function renderHUD(){ el('coins').textContent=money(state.coins); el('blueprints').textContent=fmtInt(state.blueprints); el('stoneInv').textContent=fmtInt(state.inv.stone); el('cap').textContent=fmtInt(computeWarehouseCap()); el('stoneRate').textContent=computeStoneRate().toFixed(2); }

    function renderStations(){ const cap=computeWarehouseCap(); const pct=(inventoryTotal()/cap)*100; panel.innerHTML=`
      <h2>Stations</h2>
      <div class="card"><div class="row"><strong>Drill Site</strong> <span class="small">Produces Stone</span></div>
      <div class="small">Current rate: <span class="kpi">${computeStoneRate().toFixed(2)}/s</span></div></div>
      <div class="card"><div class="row"><strong>Warehouse</strong> <span class="small right">Capacity: <span class="kpi">${fmtInt(cap)}</span></span></div>
      ${bar(pct)}
      <div class="row" style="margin-top:.5rem; gap:.4rem">
        <button class="primary" id="sell10">Sell 10 (+${money(10*TUNE.sellPrice.stone)})</button>
        <button id="sell100">Sell 100 (+${money(100*TUNE.sellPrice.stone)})</button>
        <button id="sellAll">Sell All (+${money(Math.floor(state.inv.stone)*TUNE.sellPrice.stone)})</button>
      </div>
      <div class="small muted" style="margin-top:.25rem">Tip: Enable auto-sell at cap in Settings.</div></div>`;
      panel.querySelector('#sell10').onclick=()=>{ sell('stone',10); renderHUD(); renderStations(); };
      panel.querySelector('#sell100').onclick=()=>{ sell('stone',100); renderHUD(); renderStations(); };
      panel.querySelector('#sellAll').onclick=()=>{ sellAll('stone'); renderHUD(); renderStations(); };
    }
    function renderUpgrades(){ const dpLvl=state.upgrades.drill_power; const dpCost=costGeom(TUNE.drillPowerCostBase,TUNE.drillPowerCostRate,dpLvl); const whLvl=state.upgrades.warehouse_size; const whCost=costGeom(TUNE.warehouseCostBase,TUNE.warehouseCostRate,whLvl); panel.innerHTML=`
      <h2>Upgrades</h2>
      <div class="grid cols-2">
        <div class="card"><h3>Drill Power</h3><div class="small">x${TUNE.drillPowerMult.toFixed(2)} per level ‚Äî Level <strong>${dpLvl}</strong></div>
        <div class="small">Next cost: <span class="kpi">${money(dpCost)}</span></div>
        <div class="row" style="margin-top:.4rem"><button class="primary" id="buyDP" ${state.coins<dpCost?'disabled':''}>Buy</button></div></div>
        <div class="card"><h3>Warehouse Size</h3><div class="small">+${TUNE.warehouseStep} capacity/level ‚Äî Level <strong>${whLvl}</strong></div>
        <div class="small">Next cost: <span class="kpi">${money(whCost)}</span></div>
        <div class="row" style="margin-top:.4rem"><button class="primary" id="buyWH" ${state.coins<whCost?'disabled':''}>Buy</button></div></div>
      </div>`;
      panel.querySelector('#buyDP').onclick=()=>{ buyDrillPower(); renderHUD(); renderUpgrades(); };
      panel.querySelector('#buyWH').onclick=()=>{ buyWarehouseSize(); renderHUD(); renderUpgrades(); };
    }
    function renderWorkers(){ const lvl=state.workers.miner; const cost=costGeom(60,1.25,lvl); panel.innerHTML=`
      <h2>Workers</h2>
      <div class="card"><h3>Miner</h3><div class="small">+${(TUNE.minerAddPerLevel*100).toFixed(0)}% production/level ‚Äî Level <strong>${lvl}</strong></div>
      <div class="small">Next cost: <span class="kpi">${money(cost)}</span></div>
      <div class="row" style="margin-top:.4rem"><button class="primary" id="hireMiner" ${state.coins<cost?'disabled':''}>Hire / Level Up</button></div></div>`;
      panel.querySelector('#hireMiner').onclick=()=>{ hireMiner(); renderHUD(); renderWorkers(); };
    }
    function renderContracts(){ const c=state.contract; if(!c || c.done || c.failed){ const offer=getNextOffer(); panel.innerHTML=`
      <h2>Contracts</h2>
      <div class="card"><div class="row"><strong>Offer:</strong> Deliver <span class="kpi">${offer.demand[0].qty}</span> Stone in <span class="kpi">${Math.round(offer.durationSec/60)}m</span></div>
      <div class="small">Payout: <span class="accent">${money(offer.payout)}</span> ‚Ä¢ Rush bonus: +${Math.round(offer.rushBonus*100)}%</div>
      <div class="small muted">Fail penalty: ‚àí${Math.round(offer.penalty*100)}% of payout</div>
      <div class="row" style="margin-top:.5rem"><button class="primary" id="accept">Accept Contract</button></div></div>`;
      panel.querySelector('#accept').onclick=()=>{ acceptOffer(offer); renderContracts(); };
    } else { const now=nowMs(); const left=Math.max(0,c.deadlineMs-now); const total=c.offer.durationSec*1000; const pct=(1-left/total)*100; const need=c.offer.demand[0].qty; panel.innerHTML=`
      <h2>Contracts</h2>
      <div class="card"><div class="row"><strong>Active:</strong> ${c.offer.demand[0].qty} Stone ‚Ä¢ Payout <span class="accent">${money(c.offer.payout)}</span></div>
      <div class="small">Progress: ${fmtInt(c.delivered)} / ${fmtInt(need)}</div>
      ${bar(pct)}
      <div class="small">Time left: <span class="${left<15000?'danger':'accent2'}">${Math.ceil(left/1000)}s</span></div>
      <div class="row" style="margin-top:.5rem"><button id="cancel" ${c.done||c.failed?'disabled':''}>Cancel</button></div></div>`;
      panel.querySelector('#cancel').onclick=()=>{ if(!c.done && !c.failed){ c.failed=true; } renderContracts(); };
    }}
    function renderStats(){ panel.innerHTML=`
      <h2>Stats</h2>
      <div class="card"><div>Stone Rate: <span class="kpi">${computeStoneRate().toFixed(2)}/s</span></div>
      <div>Warehouse Cap: <span class="kpi">${fmtInt(computeWarehouseCap())}</span></div>
      <div>Inventory: <span class="kpi">${fmtInt(state.inv.stone)}</span> Stone</div></div>
      <div class="small muted">Dev note: more charts and bottleneck hints later.</div>`; }
    function renderSettings(){ panel.innerHTML=`
      <h2>Settings</h2>
      <div class="card row" style="justify-content:space-between"><div><div><strong>Auto-sell Stone at capacity</strong></div>
      <div class="small muted">When the warehouse is full, automatically sell all stone.</div></div>
      <label class="row" style="gap:.5rem; align-items:center"><input type="checkbox" id="autoSell" ${state.options.autoSellAtCap?'checked':''}/><span>Enabled</span></label></div>
      <div class="card"><div class="row" style="gap:.5rem; flex-wrap:wrap">
        <button id="saveBtn">Save Now</button><button id="resetBtn" class="danger">Reset Save</button>
        <a href="#" id="exportBtn"><button>Export Save</button></a>
        <input id="importInput" type="file" accept=".json" style="display:none" />
        <button id="importBtn">Import Save</button>
      </div><div class="small muted" style="margin-top:.4rem">Save is automatic every ${(TUNE.autosaveMs/1000)|0}s.</div></div>`;
      panel.querySelector('#autoSell').onchange=e=>{ state.options.autoSellAtCap=!!e.target.checked; };
      panel.querySelector('#saveBtn').onclick=()=> save();
      panel.querySelector('#resetBtn').onclick=()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); };
      panel.querySelector('#exportBtn').onclick=e=>{ e.preventDefault(); const blob=new Blob([localStorage.getItem(SAVE_KEY)||'{}'],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='idle-mining-save.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000); };
      panel.querySelector('#importBtn').onclick=()=> panel.querySelector('#importInput').click();
      panel.querySelector('#importInput').onchange=ev=>{ const f=ev.target.files?.[0]; if(!f) return; const reader=new FileReader(); reader.onload=()=>{ try{ localStorage.setItem(SAVE_KEY, reader.result); location.reload(); }catch{} }; reader.readAsText(f); };
    }

    // ---------- Modal
    function showOfflineModal({elapsedSec, considered, produced, rate}){ const wrap=el('modalWrap'); const det=el('offlineDetails'); det.innerHTML=`
      <div class="card"><div class="row"><strong>Elapsed:</strong>&nbsp;<span>${Math.floor(elapsedSec/60)}m ${elapsedSec%60}s</span></div>
      <div class="row"><strong>Counted:</strong>&nbsp;<span>${Math.floor(considered/60)}m ${considered%60}s</span> <span class="small muted">(cap ${Math.floor(TUNE.offlineCapSec/60)}m)</span></div>
      <div class="row"><strong>Rate:</strong>&nbsp;<span>${rate.toFixed(2)} stone/s</span> √ó <span>${(TUNE.offlineMult*100)|0}%</span></div>
      <div class="row"><strong>Stone produced:</strong>&nbsp;<span class="kpi">${fmtInt(produced)}</span></div></div>`; wrap.style.display='flex'; el('closeModal').onclick=()=>{ wrap.style.display='none'; }; }

    // ---------- Visuals (Canvas)
    const canvas = el('scene'); const ctx = canvas.getContext('2d');
    function resizeCanvas(){ const w = window.innerWidth; const h = 280; const dpr = window.devicePixelRatio || 1; canvas.width = Math.floor(w * dpr); canvas.height = Math.floor(h * dpr); canvas.style.width = w+'px'; canvas.style.height = h+'px'; ctx.setTransform(dpr,0,0,dpr,0,0); }
    window.addEventListener('resize', resizeCanvas); resizeCanvas();

    const world = { groundY: 220, mineX: 90, whX: () => canvas.width/(window.devicePixelRatio||1) - 110 };
    const visual = { state:'MINE', x: 90, y: 220-28, speed: 120, carry: 0, carryCap: 40, pickAngle: 0, pickDir: 1, walkPhase: 0 };

    function updateVisual(dt){
      // Accumulate carry from produced resources (visual sync only)
      visual.carry = clamp(visual.carry + state.producedLastTick, 0, 9999);
      if(visual.state==='MINE'){
        // pick swing
        visual.pickAngle += visual.pickDir * dt * 6; if(visual.pickAngle>0.6){ visual.pickDir=-1; } if(visual.pickAngle<-0.6){ visual.pickDir=1; }
        // if carry full enough, head to warehouse
        if(visual.carry >= visual.carryCap*0.95){ visual.state='TO_WH'; }
      }
      if(visual.state==='TO_WH'){
        visual.x += visual.speed * dt; visual.walkPhase += dt*10; if(visual.x >= world.whX()){ visual.x = world.whX(); visual.state='DEPOSIT'; }
      } else if(visual.state==='TO_MINE'){
        visual.x -= visual.speed * dt; visual.walkPhase += dt*10; if(visual.x <= world.mineX){ visual.x = world.mineX; visual.state='MINE'; }
      } else if(visual.state==='DEPOSIT'){
        // Drop visually (inventory already updated by logic). Empty the backpack quickly.
        visual.carry = Math.max(0, visual.carry - visual.carryCap);
        visual.state = 'TO_MINE';
      }
    }

    function draw(){
      const w = canvas.width/(window.devicePixelRatio||1), h = canvas.height/(window.devicePixelRatio||1);
      // background
      ctx.fillStyle = '#0c0f14'; ctx.fillRect(0,0,w,h);
      // stars/noise (subtle)
      ctx.fillStyle = '#0e131a'; for(let i=0;i<40;i++){ ctx.fillRect((i*17)%w, (i*23)%120, 2,2); }

      // ground
      ctx.fillStyle = '#12161d'; ctx.fillRect(0, world.groundY, w, h-world.groundY);
      ctx.strokeStyle = '#202630'; ctx.beginPath(); ctx.moveTo(0, world.groundY); ctx.lineTo(w, world.groundY); ctx.stroke();

      // mine block (stone)
      const mineY = world.groundY-36;
      drawStoneBlock(world.mineX-32, mineY, 48, 36);
      // warehouse (crate stack)
      const whX = world.whX(); const whY = world.groundY-38; drawWarehouse(whX-24, whY);

      // path line
      ctx.strokeStyle = '#1f2933'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(world.mineX, world.groundY-6); ctx.lineTo(whX, world.groundY-6); ctx.stroke();

      // avatar
      drawAvatar(visual.x, visual.y, visual);

      // floating UI: backpack fill
      const capPct = clamp(visual.carry/visual.carryCap*100,0,100);
      ctx.fillStyle = '#0e1117'; ctx.fillRect(visual.x-20, visual.y-46, 40, 8); ctx.strokeStyle='#2a2e36'; ctx.strokeRect(visual.x-20, visual.y-46, 40, 8);
      ctx.fillStyle = '#4fd36a'; ctx.fillRect(visual.x-20, visual.y-46, 40*(capPct/100), 8);

      // labels
      ctx.fillStyle = '#a7a7b7'; ctx.font = '12px system-ui, Segoe UI, Roboto, Arial'; ctx.fillText('Mine', world.mineX-10, world.groundY+14);
      ctx.fillText('Warehouse', whX-40, world.groundY+14);
    }

    function drawStoneBlock(x,y,w,h){
      ctx.fillStyle = '#3f4958'; ctx.fillRect(x,y,w,h); ctx.strokeStyle = '#2a3140'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1);
      // speckles
      ctx.fillStyle = '#586273'; for(let i=0;i<8;i++){ const sx=x+4+((i*13)%w)*0.6; const sy=y+4+((i*19)%h)*0.5; ctx.fillRect(sx, sy, 4, 3); }
      ctx.fillStyle = '#2e3644'; for(let i=0;i<6;i++){ const sx=x+10+((i*17)%w)*0.5; const sy=y+8+((i*11)%h)*0.6; ctx.fillRect(sx, sy, 3, 3); }
    }
    function drawWarehouse(x,y){
      // two stacked crates
      drawCrate(x-22,y, 24,22); drawCrate(x+2,y, 24,22); drawCrate(x-10,y-22, 24,22);
    }
    function drawCrate(x,y,w,h){ ctx.fillStyle='#5c4128'; ctx.fillRect(x,y,w,h); ctx.strokeStyle='#3b2a1b'; ctx.strokeRect(x+0.5,y+0.5,w-1,h-1); ctx.strokeStyle='#775234'; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+w,y+h); ctx.moveTo(x+w,y); ctx.lineTo(x,y+h); ctx.stroke(); }

    function drawAvatar(x,y,v){
      // blocky miner (generic voxel-style)
      // legs (walk animation)
      const step = Math.sin(v.walkPhase)*4;
      ctx.fillStyle = '#2b3442'; ctx.fillRect(x-10, y, 8, 16); // left leg
      ctx.fillRect(x+2, y, 8, 16); // right leg
      ctx.save(); ctx.translate(x-10, y); ctx.fillRect(0, step>0?0:-step, 8, 16); ctx.restore();
      ctx.save(); ctx.translate(x+2, y); ctx.fillRect(0, step<0?0:step, 8, 16); ctx.restore();
      // torso
      ctx.fillStyle = '#3e4e63'; ctx.fillRect(x-12, y-18, 28, 20);
      // backpack (carry)
      ctx.fillStyle = '#2a2e36'; ctx.fillRect(x+14, y-16, 8, 16);
      const fill = clamp((v.carry/v.carryCap)*16,0,16); ctx.fillStyle='#4fd36a'; ctx.fillRect(x+14, y-16+(16-fill), 8, fill);
      // head
      ctx.fillStyle = '#d9c2a0'; ctx.fillRect(x-8, y-32, 16, 14);
      // helmet
      ctx.fillStyle = '#7dafff'; ctx.fillRect(x-10, y-36, 20, 8); ctx.fillStyle='#5b8fd6'; ctx.fillRect(x-10, y-36, 20, 3);
      // pickaxe (simple line + head)
      if(v.state==='MINE'){
        ctx.save(); ctx.translate(x-20, y-18); ctx.rotate(v.pickAngle);
        ctx.strokeStyle = '#825a2b'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-18, -4); ctx.stroke();
        ctx.fillStyle = '#9aa7b8'; ctx.fillRect(-22, -8, 8, 6);
        ctx.restore();
      } else {
        // carry pick while walking
        ctx.strokeStyle = '#825a2b'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(x-8,y-14); ctx.lineTo(x-24,y-22); ctx.stroke(); ctx.fillStyle='#9aa7b8'; ctx.fillRect(x-28,y-26,8,6);
      }
    }

    // ---------- Wiring
    document.querySelectorAll('.tabbar [data-tab]').forEach(b=> b.addEventListener('click', ()=> setTab(b.dataset.tab)));

    // Initial load
    applyLoad(load()); renderHUD(); setTab('stations');
    setInterval(save, TUNE.autosaveMs); window.addEventListener('visibilitychange', ()=>{ if(document.hidden) save(); }); window.addEventListener('beforeunload', save);

    // Main loop
    (function loop(){ const now=nowMs(); const dt=(now - state.lastTickMs)/1000; state.lastTickMs=now; tick(dt); updateVisual(dt); renderHUD(); draw(); requestAnimationFrame(loop); })();

  })();
  </script>
</body>
</html>
