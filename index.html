<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Idle Mining Tycoon ‚Äî Prototype (No Build)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f0f12;
      --panel: #17191f;
      --accent: #4fd36a;
      --accent-2: #5bb7ff;
      --text: #e8e8ee;
      --muted: #a7a7b7;
      --danger: #ff6b6b;
      --warn: #ffd36b;
      --border: #2a2e36;
      --card: #14171d;
    }
    * { box-sizing: border-box }
    html, body { height: 100% }
    body {
      margin: 0; background: linear-gradient(180deg,#0e1015,#0b0d12 200px) fixed;
      color: var(--text); font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    #hud {
      position: fixed; left: 0; right: 0; top: 0;
      display: flex; gap: .75rem; align-items: center; flex-wrap: wrap;
      padding: .6rem .75rem; background: rgba(0,0,0,.35); backdrop-filter: blur(4px);
      border-bottom: 1px solid var(--border); z-index: 10;
      font-weight: 600;
    }
    #hud .pill {
      background: var(--panel); border: 1px solid var(--border);
      padding: .35rem .6rem; border-radius: .6rem; display: flex; gap: .4rem; align-items: center;
    }
    #main { padding-top: 56px; padding-bottom: 62px; }
    .tabbar {
      position: fixed; left: 0; right: 0; bottom: 0; z-index: 10;
      background: #0b0d12; border-top: 1px solid var(--border);
      display: grid; grid-template-columns: repeat(6, 1fr); gap: .25rem; padding: .35rem;
    }
    .tabbar button {
      background: var(--panel); color: var(--text); border: 1px solid var(--border);
      padding: .6rem .4rem; border-radius: .6rem; font-weight: 600; cursor: pointer;
    }
    .tabbar button.active { outline: 2px solid var(--accent); }
    .panel {
      position: fixed; left: .6rem; right: .6rem; bottom: 3.2rem; top: 3.2rem;
      background: var(--panel); border: 1px solid var(--border); border-radius: .8rem;
      padding: .8rem; overflow: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h2, h3 { margin: .2rem 0 .6rem }
    .row { display: flex; gap: .6rem; align-items: center; flex-wrap: wrap; }
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: .8rem; padding: .8rem; margin-bottom: .6rem;
    }
    .small { color: var(--muted); font-size: .9rem }
    button {
      background: #1a1f26; color: var(--text); border: 1px solid var(--border);
      padding: .5rem .75rem; border-radius: .6rem; cursor: pointer; font-weight: 600;
    }
    button.primary { background: #1a2520; border-color: #1f3d2a; color: #dfffe9 }
    button:disabled { opacity: .55; cursor: not-allowed }
    progress { width: 100%; height: 10px; }
    .kpi { font-weight: 700; color: var(--accent) }
    .accent { color: var(--accent) }
    .accent2 { color: var(--accent-2) }
    .danger { color: var(--danger) }
    .warn { color: var(--warn) }
    .grid { display: grid; gap: .6rem }
    .grid.cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)) }
    @media (max-width: 720px) { .grid.cols-2 { grid-template-columns: 1fr } }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,.55);
      display: none; align-items: center; justify-content: center; z-index: 20;
    }
    .modal { width: min(720px, 96vw); background: var(--panel); border: 1px solid var(--border);
      border-radius: .8rem; padding: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,.5); }
    .modal h3 { margin-top: 0 }
    .right { margin-left: auto }
    .bar {
      height: 10px; background: #0e1117; border: 1px solid var(--border);
      border-radius: 4px; overflow: hidden;
    }
    .bar > i {
      display: block; height: 100%; background: linear-gradient(90deg, var(--accent), #7be495);
      width: 0%;
    }
    .muted { color: var(--muted) }
  </style>
</head>
<body>
  <!-- HUD -->
  <div id="hud">
    <div class="pill">üí∞ Coins: <span id="coins">0</span></div>
    <div class="pill">üß∞ Blueprints: <span id="blueprints">0</span></div>
    <div class="pill">‚õèÔ∏è Stone: <span id="stoneInv">0</span>/<span id="cap">200</span></div>
    <div class="pill">‚ö° Rate: <span id="stoneRate">0</span>/s</div>
    <div class="pill small">üïí Autosave</div>
  </div>

  <div id="main"></div>

  <!-- Panel (content swaps via tabs) -->
  <div id="panel" class="panel" hidden></div>

  <!-- Tabs -->
  <div class="tabbar">
    <button data-tab="stations" class="active">Stations</button>
    <button data-tab="upgrades">Upgrades</button>
    <button data-tab="workers">Workers</button>
    <button data-tab="contracts">Contracts</button>
    <button data-tab="stats">Stats</button>
    <button data-tab="settings">Settings</button>
  </div>

  <!-- Offline modal -->
  <div id="modalWrap" class="modal-backdrop">
    <div class="modal">
      <h3>‚õèÔ∏è Offline Progress</h3>
      <div id="offlineDetails" class="small"></div>
      <div class="row" style="margin-top:.6rem">
        <button id="closeModal" class="primary right">Continue</button>
      </div>
    </div>
  </div>

  <!-- (Optional) Inline JSON configs for future expansion -->
  <script type="application/json" id="cfg-contracts">
  {
    "offers": [
      { "id": "c-stone-100", "demand": [{"res":"stone", "qty":100}], "durationSec": 300, "payout": 180, "rushBonus": 0.20, "penalty": 0.10 },
      { "id": "c-stone-200", "demand": [{"res":"stone", "qty":200}], "durationSec": 420, "payout": 360, "rushBonus": 0.20, "penalty": 0.10 }
    ]
  }
  </script>

  <script>
  (function(){
    // -------- Utilities
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const nowMs = () => Date.now();
    const fmtInt = n => Math.floor(n).toLocaleString();
    const money = n => fmtInt(n);
    const el = id => document.getElementById(id);

    // -------- Baseline tuning (MVP)
    const TUNE = {
      baseStoneRate: 1.0,              // items/sec
      minerAddPerLevel: 0.05,          // +5% per miner level
      drillPowerMult: 1.15,            // per upgrade level
      drillPowerCostBase: 50, drillPowerCostRate: 1.18,

      warehouseBase: 200, warehouseStep: 50,
      warehouseCostBase: 80, warehouseCostRate: 1.17,

      sellPrice: { stone: 1 },

      autosaveMs: 10_000,
      offlineMult: 0.20,               // 20% of online rate
      offlineCapSec: 20 * 60,          // 20 minutes cap for MVP
      version: 1
    };

    // -------- State
    const state = {
      version: TUNE.version,
      coins: 0,
      blueprints: 0,
      inv: { stone: 0 },
      upgrades: { drill_power: 0, warehouse_size: 0 },
      workers: { miner: 0 },
      // derived / runtime
      lastTickMs: nowMs(),
      contract: null,     // {offer, acceptedAtMs, deadlineMs, delivered, done, failed}
      options: { autoSellAtCap: false },
    };

    // -------- Persistence
    const SAVE_KEY = 'imt_proto_save_v1';
    function save() {
      const data = {
        version: state.version,
        coins: state.coins,
        blueprints: state.blueprints,
        inv: state.inv,
        upgrades: state.upgrades,
        workers: state.workers,
        contract: state.contract ? {
          offer: state.contract.offer, acceptedAtMs: state.contract.acceptedAtMs,
          deadlineMs: state.contract.deadlineMs, delivered: state.contract.delivered,
          done: state.contract.done, failed: state.contract.failed
        } : null,
        options: state.options,
        lastActiveMs: nowMs()
      };
      try { localStorage.setItem(SAVE_KEY, JSON.stringify(data)); } catch {}
    }
    function load() {
      const raw = localStorage.getItem(SAVE_KEY);
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function applyLoad(s) {
      if (!s) return;
      state.version = s.version ?? state.version;
      state.coins = s.coins ?? 0;
      state.blueprints = s.blueprints ?? 0;
      state.inv = Object.assign({stone:0}, s.inv||{});
      state.upgrades = Object.assign({drill_power:0, warehouse_size:0}, s.upgrades||{});
      state.workers = Object.assign({miner:0}, s.workers||{});
      state.contract = s.contract || null;
      state.options = Object.assign({autoSellAtCap:false}, s.options||{});
      // Offline gains
      const last = s.lastActiveMs || nowMs();
      const elapsedSec = Math.max(0, Math.floor((nowMs() - last)/1000));
      if (elapsedSec > 3) {
        const considered = Math.min(elapsedSec, TUNE.offlineCapSec);
        const rate = computeStoneRate(); // current rate (approx)
        const produced = rate * considered * TUNE.offlineMult;
        const before = state.inv.stone;
        addToInventory('stone', produced);
        const after = state.inv.stone;
        showOfflineModal({ elapsedSec, considered, produced: after - before, rate });
      }
    }

    // -------- Rates / Capacity
    function computeWarehouseCap() {
      return TUNE.warehouseBase + state.upgrades.warehouse_size * TUNE.warehouseStep;
    }
    function computeStoneRate() {
      const multFromDrill = Math.pow(TUNE.drillPowerMult, state.upgrades.drill_power);
      const minerMult = 1 + (state.workers.miner * TUNE.minerAddPerLevel);
      return TUNE.baseStoneRate * multFromDrill * minerMult;
    }
    function inventoryTotal() { return state.inv.stone; } // single resource MVP
    function addToInventory(res, qty) {
      if (qty <= 0) return 0;
      const cap = computeWarehouseCap();
      const room = Math.max(0, cap - inventoryTotal());
      const add = Math.min(room, qty);
      state.inv[res] = (state.inv[res] || 0) + add;
      return add;
    }

    // -------- Economy
    const costGeom = (base, rate, lvl) => Math.floor(base * Math.pow(rate, lvl));
    function buyDrillPower() {
      const c = costGeom(TUNE.drillPowerCostBase, TUNE.drillPowerCostRate, state.upgrades.drill_power);
      if (state.coins >= c) { state.coins -= c; state.upgrades.drill_power++; renderIfTab('upgrades'); }
    }
    function buyWarehouseSize() {
      const c = costGeom(TUNE.warehouseCostBase, TUNE.warehouseCostRate, state.upgrades.warehouse_size);
      if (state.coins >= c) { state.coins -= c; state.upgrades.warehouse_size++; renderIfTab('upgrades'); }
    }
    function hireMiner() {
      const base = 60, rate = 1.25, lvl = state.workers.miner;
      const c = costGeom(base, rate, lvl);
      if (state.coins >= c) { state.coins -= c; state.workers.miner++; renderIfTab('workers'); }
    }

    // -------- Selling
    function sell(res, qty) {
      const have = Math.floor(state.inv[res] || 0);
      const sellQty = Math.max(0, Math.min(have, qty));
      if (sellQty <= 0) return 0;
      state.inv[res] -= sellQty;
      const gain = sellQty * (TUNE.sellPrice[res] || 0);
      state.coins += gain;
      return sellQty;
    }
    function sellAll(res) {
      const qty = Math.floor(state.inv[res] || 0);
      return sell(res, qty);
    }

    // -------- Contracts
    const CONTRACT_OFFERS = JSON.parse(document.getElementById('cfg-contracts').textContent).offers;
    let rotatingOfferIdx = 0;
    function getNextOffer() {
      const offer = CONTRACT_OFFERS[rotatingOfferIdx % CONTRACT_OFFERS.length];
      rotatingOfferIdx++;
      // shallow clone
      return JSON.parse(JSON.stringify(offer));
    }
    function acceptOffer(offer) {
      if (state.contract && !state.contract.done && !state.contract.failed) return;
      const now = nowMs();
      state.contract = {
        offer, acceptedAtMs: now, deadlineMs: now + offer.durationSec * 1000,
        delivered: 0, done: false, failed: false
      };
      renderIfTab('contracts');
    }
    function tickContract(dt) {
      if (!state.contract || state.contract.done || state.contract.failed) return;
      const c = state.contract, o = c.offer;
      // auto-deliver if we have inventory
      const need = o.demand[0].qty - c.delivered;
      if (need > 0) {
        const deliverNow = Math.min(need, Math.floor(state.inv[o.demand[0].res] || 0));
        if (deliverNow > 0) { state.inv[o.demand[0].res] -= deliverNow; c.delivered += deliverNow; }
      }
      if (c.delivered >= o.demand[0].qty) {
        // success; rush bonus if >25% time left
        const now = nowMs();
        const total = o.durationSec * 1000;
        const left = Math.max(0, c.deadlineMs - now);
        const leftPct = left / total;
        const bonus = leftPct >= 0.25 ? o.rushBonus : 0;
        const payout = o.payout * (1 + bonus);
        state.coins += payout;
        c.done = true;
      } else if (nowMs() >= c.deadlineMs) {
        // failed
        const penalty = Math.floor(o.payout * o.penalty);
        state.coins = Math.max(0, state.coins - penalty);
        c.failed = true;
      }
    }

    // -------- Ticker
    function tick(dt) {
      // Production
      const produced = computeStoneRate() * dt;
      const added = addToInventory('stone', produced);

      // Auto-sell if enabled and full
      if (state.options.autoSellAtCap) {
        const cap = computeWarehouseCap();
        if (inventoryTotal() >= cap) sellAll('stone');
      }

      tickContract(dt);
    }

    // -------- UI
    const panel = el('panel');
    let currentTab = 'stations';

    function setTab(name) {
      currentTab = name;
      document.querySelectorAll('.tabbar button').forEach(b=>{
        b.classList.toggle('active', b.dataset.tab === name);
      });
      panel.hidden = false;
      ({
        stations: renderStations,
        upgrades: renderUpgrades,
        workers: renderWorkers,
        contracts: renderContracts,
        stats: renderStats,
        settings: renderSettings
      }[name] || renderStations)();
    }
    function renderIfTab(name) { if (currentTab === name) ({ stations: renderStations, upgrades: renderUpgrades, workers: renderWorkers, contracts: renderContracts, stats: renderStats, settings: renderSettings }[name]()); }
    function bar(percent) { percent = clamp(percent, 0, 100); return `<div class="bar"><i style="width:${percent}%"></i></div>`; }

    // HUD
    function renderHUD() {
      el('coins').textContent = money(state.coins);
      el('blueprints').textContent = fmtInt(state.blueprints);
      el('stoneInv').textContent = fmtInt(state.inv.stone);
      el('cap').textContent = fmtInt(computeWarehouseCap());
      el('stoneRate').textContent = computeStoneRate().toFixed(2);
    }

    // Panels
    function renderStations() {
      const cap = computeWarehouseCap();
      const pct = (inventoryTotal()/cap)*100;
      panel.innerHTML = `
        <h2>Stations</h2>
        <div class="card">
          <div class="row"><strong>Drill Site</strong> <span class="small">Produces Stone</span></div>
          <div class="small">Current rate: <span class="kpi">${computeStoneRate().toFixed(2)}/s</span></div>
        </div>
        <div class="card">
          <div class="row"><strong>Warehouse</strong> <span class="small right">Capacity: <span class="kpi">${fmtInt(cap)}</span></span></div>
          ${bar(pct)}
          <div class="row" style="margin-top:.5rem; gap:.4rem">
            <button class="primary" id="sell10">Sell 10 (+${money(10*TUNE.sellPrice.stone)})</button>
            <button id="sell100">Sell 100 (+${money(100*TUNE.sellPrice.stone)})</button>
            <button id="sellAll">Sell All (+${money(Math.floor(state.inv.stone)*TUNE.sellPrice.stone)})</button>
          </div>
          <div class="small muted" style="margin-top:.25rem">Tip: Enable auto-sell at cap in Settings.</div>
        </div>`;
      panel.querySelector('#sell10').onclick = ()=>{ sell('stone',10); renderHUD(); renderStations(); };
      panel.querySelector('#sell100').onclick = ()=>{ sell('stone',100); renderHUD(); renderStations(); };
      panel.querySelector('#sellAll').onclick = ()=>{ sellAll('stone'); renderHUD(); renderStations(); };
    }

    function renderUpgrades() {
      const dpLvl = state.upgrades.drill_power;
      const dpCost = costGeom(TUNE.drillPowerCostBase, TUNE.drillPowerCostRate, dpLvl);
      const whLvl = state.upgrades.warehouse_size;
      const whCost = costGeom(TUNE.warehouseCostBase, TUNE.warehouseCostRate, whLvl);
      panel.innerHTML = `
        <h2>Upgrades</h2>
        <div class="grid cols-2">
          <div class="card">
            <h3>Drill Power</h3>
            <div class="small">x${TUNE.drillPowerMult.toFixed(2)} per level ‚Äî Level <strong>${dpLvl}</strong></div>
            <div class="small">Next cost: <span class="kpi">${money(dpCost)}</span></div>
            <div class="row" style="margin-top:.4rem">
              <button class="primary" id="buyDP" ${state.coins<dpCost?'disabled':''}>Buy</button>
            </div>
          </div>
          <div class="card">
            <h3>Warehouse Size</h3>
            <div class="small">+${TUNE.warehouseStep} capacity per level ‚Äî Level <strong>${whLvl}</strong></div>
            <div class="small">Next cost: <span class="kpi">${money(whCost)}</span></div>
            <div class="row" style="margin-top:.4rem">
              <button class="primary" id="buyWH" ${state.coins<whCost?'disabled':''}>Buy</button>
            </div>
          </div>
        </div>
      `;
      panel.querySelector('#buyDP').onclick = ()=>{ buyDrillPower(); renderHUD(); renderUpgrades(); };
      panel.querySelector('#buyWH').onclick = ()=>{ buyWarehouseSize(); renderHUD(); renderUpgrades(); };
    }

    function renderWorkers() {
      const lvl = state.workers.miner;
      const cost = costGeom(60, 1.25, lvl);
      panel.innerHTML = `
        <h2>Workers</h2>
        <div class="card">
          <h3>Miner</h3>
          <div class="small">+${(TUNE.minerAddPerLevel*100).toFixed(0)}% production per level ‚Äî Level <strong>${lvl}</strong></div>
          <div class="small">Next cost: <span class="kpi">${money(cost)}</span></div>
          <div class="row" style="margin-top:.4rem"><button class="primary" id="hireMiner" ${state.coins<cost?'disabled':''}>Hire / Level Up</button></div>
        </div>
      `;
      panel.querySelector('#hireMiner').onclick = ()=>{ hireMiner(); renderHUD(); renderWorkers(); };
    }

    function renderContracts() {
      const c = state.contract;
      if (!c || c.done || c.failed) {
        const offer = getNextOffer();
        panel.innerHTML = `
          <h2>Contracts</h2>
          <div class="card">
            <div class="row"><strong>Offer:</strong> Deliver <span class="kpi">${offer.demand[0].qty}</span> Stone in <span class="kpi">${Math.round(offer.durationSec/60)}m</span></div>
            <div class="small">Payout: <span class="accent">${money(offer.payout)}</span> ‚Ä¢ Rush bonus: +${Math.round(offer.rushBonus*100)}%</div>
            <div class="small muted">Fail penalty: ‚àí${Math.round(offer.penalty*100)}% of payout</div>
            <div class="row" style="margin-top:.5rem"><button class="primary" id="accept">Accept Contract</button></div>
          </div>`;
        panel.querySelector('#accept').onclick = ()=>{ acceptOffer(offer); renderContracts(); };
      } else {
        const now = nowMs();
        const left = Math.max(0, c.deadlineMs - now);
        const total = c.offer.durationSec * 1000;
        const pct = (1 - left/total) * 100;
        const need = c.offer.demand[0].qty;
        panel.innerHTML = `
          <h2>Contracts</h2>
          <div class="card">
            <div class="row"><strong>Active:</strong> ${c.offer.demand[0].qty} Stone ‚Ä¢ Payout <span class="accent">${money(c.offer.payout)}</span></div>
            <div class="small">Progress: ${fmtInt(c.delivered)} / ${fmtInt(need)}</div>
            ${bar(pct)}
            <div class="small">Time left: <span class="${left<15000?'danger':'accent2'}">${Math.ceil(left/1000)}s</span></div>
            <div class="row" style="margin-top:.5rem">
              <button id="cancel" ${c.done||c.failed?'disabled':''}>Cancel</button>
            </div>
          </div>`;
        panel.querySelector('#cancel').onclick = ()=>{ if (!c.done && !c.failed) { c.failed = true; } renderContracts(); };
      }
    }

    function renderStats() {
      panel.innerHTML = `
        <h2>Stats</h2>
        <div class="card">
          <div>Stone Rate: <span class="kpi">${computeStoneRate().toFixed(2)}/s</span></div>
          <div>Warehouse Cap: <span class="kpi">${fmtInt(computeWarehouseCap())}</span></div>
          <div>Inventory: <span class="kpi">${fmtInt(state.inv.stone)}</span> Stone</div>
        </div>
        <div class="small muted">Dev note: more charts and bottleneck hints come later.</div>
      `;
    }

    function renderSettings() {
      panel.innerHTML = `
        <h2>Settings</h2>
        <div class="card row" style="justify-content:space-between">
          <div>
            <div><strong>Auto-sell Stone at capacity</strong></div>
            <div class="small muted">When the warehouse is full, automatically sell all stone.</div>
          </div>
          <label class="row" style="gap:.5rem; align-items:center">
            <input type="checkbox" id="autoSell" ${state.options.autoSellAtCap?'checked':''}/>
            <span>Enabled</span>
          </label>
        </div>
        <div class="card">
          <div class="row" style="gap:.5rem; flex-wrap:wrap">
            <button id="saveBtn">Save Now</button>
            <button id="resetBtn" class="danger">Reset Save</button>
            <a href="#" id="exportBtn"><button>Export Save</button></a>
            <input id="importInput" type="file" accept=".json" style="display:none" />
            <button id="importBtn">Import Save</button>
          </div>
          <div class="small muted" style="margin-top:.4rem">Save is automatic every ${(TUNE.autosaveMs/1000)|0}s.</div>
        </div>
      `;
      panel.querySelector('#autoSell').onchange = (e)=>{ state.options.autoSellAtCap = !!e.target.checked; };
      panel.querySelector('#saveBtn').onclick = ()=> save();
      panel.querySelector('#resetBtn').onclick = ()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); };
      panel.querySelector('#exportBtn').onclick = (e)=>{
        e.preventDefault();
        const blob = new Blob([localStorage.getItem(SAVE_KEY) || '{}'], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'idle-mining-save.json'; a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
      };
      panel.querySelector('#importBtn').onclick = ()=> panel.querySelector('#importInput').click();
      panel.querySelector('#importInput').onchange = ev=>{
        const f = ev.target.files?.[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = ()=>{ try{ localStorage.setItem(SAVE_KEY, reader.result); location.reload(); }catch{} };
        reader.readAsText(f);
      };
    }

    // -------- Modal
    function showOfflineModal({elapsedSec, considered, produced, rate}) {
      const wrap = el('modalWrap');
      const det = el('offlineDetails');
      det.innerHTML = `
        <div class="card">
          <div class="row"><strong>Elapsed:</strong>&nbsp;<span>${Math.floor(elapsedSec/60)}m ${elapsedSec%60}s</span></div>
          <div class="row"><strong>Counted:</strong>&nbsp;<span>${Math.floor(considered/60)}m ${considered%60}s</span> <span class="small muted">(cap ${Math.floor(TUNE.offlineCapSec/60)}m)</span></div>
          <div class="row"><strong>Rate:</strong>&nbsp;<span>${rate.toFixed(2)} stone/s</span> √ó <span>${(TUNE.offlineMult*100)|0}%</span></div>
          <div class="row"><strong>Stone produced:</strong>&nbsp;<span class="kpi">${fmtInt(produced)}</span></div>
        </div>
      `;
      wrap.style.display = 'flex';
      el('closeModal').onclick = ()=>{ wrap.style.display = 'none'; };
    }

    // -------- Wiring
    document.querySelectorAll('.tabbar [data-tab]').forEach(b=>{
      b.addEventListener('click', ()=> setTab(b.dataset.tab));
    });

    // Initial load & render
    applyLoad(load());
    renderHUD();
    setTab('stations');

    // Autosave
    setInterval(save, TUNE.autosaveMs);
    window.addEventListener('visibilitychange', ()=>{ if (document.hidden) save(); });
    window.addEventListener('beforeunload', save);

    // Main loop
    (function loop(){
      const now = nowMs();
      const dt = (now - state.lastTickMs) / 1000;
      state.lastTickMs = now;
      tick(dt);
      renderHUD();
      requestAnimationFrame(loop);
    })();

  })();
  </script>
</body>
</html>
