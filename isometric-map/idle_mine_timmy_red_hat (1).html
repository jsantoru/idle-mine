<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Idle Mine ‚Äì Timmy RedHat (Iso + UI)</title>
<style>
  :root{--bg:#0f1216;--panel:#171b22;--muted:#9bb0c3;--line:#242a33;--text:#eaf1f7;--accent:#86efac;--accent2:#7aa2ff;--warn:#f59e0b;--good:#34d399;--bad:#ef4444;--pill:#ffffffcc;--pillBorder:#00000010}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Arial;overflow:hidden}
  .app{display:grid;grid-template-columns:minmax(0,1fr) clamp(320px,28vw,420px);grid-template-rows:100vh}
  #canvas{display:block;width:100%;height:100%;background:#e9eef5}
  #hud{position:fixed;top:14px;left:14px;display:flex;gap:10px;z-index:10}
  .pill{backdrop-filter:blur(8px);background:var(--pill);border:1px solid var(--pillBorder);border-radius:14px;padding:8px 12px;color:#111;font-weight:600}
  .pill b{color:#000}
  aside{height:100vh;overflow:auto;background:var(--panel);border-left:1px solid var(--line)}
  h2{margin:18px 16px 10px;font-size:22px}
  .card{margin:12px 12px 0;background:#10151c;border:1px solid var(--line);border-radius:12px;padding:14px}
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .green{color:var(--good)}.blue{color:var(--accent2)}.warn{color:var(--warn)}
  button{background:#1a222c;border:1px solid #263040;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  button:disabled{opacity:.4;cursor:not-allowed}
  .btnGreen{background:#17321f;border-color:#1c3a25}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid2 .card{margin:0}
  .chip{display:inline-block;background:#0f1720;border:1px solid var(--line);padding:4px 8px;border-radius:8px;margin-right:6px}
  .compact{margin:4px 0 0;font-size:12px}
  .big{font-size:18px;font-weight:700}
  #legend{position:fixed;right:12px;bottom:12px;z-index:10;background:#ffffffcc;color:#111;border:1px solid #00000010;border-radius:10px;padding:8px 10px}
  a{color:#9dc1ff;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <div id="hud">
      <div class="pill">Coal: <b id="hudCoal">0</b></div>
      <div class="pill">Ore: <b id="hudOre">0</b></div>
      <div class="pill">Chunks: <b id="hudChunks">0</b></div>
      <div class="pill">Ingots: <b id="hudIngots">0</b></div>
      <div class="pill">$ <b id="hudMoney">0</b></div>
    </div>
    <canvas id="canvas"></canvas>
    <div id="legend">Drag = pan ¬∑ Wheel = zoom ¬∑ Timmy has the red hat ‚ù§</div>
  </div>
  <aside>
    <h2>Stations</h2>
    <div class="card">
      <div class="big">Mine <span class="muted">Coal + Ore</span></div>
      <div>Coal: <span id="mineCoalRate" class="green">0/s</span> <span class="muted">‚Ä¢</span> Ore: <span id="mineOreRate" class="blue">0/s</span></div>
    </div>
    <div class="card">
      <div class="big">Cart (Top Track) <span class="muted">Carries coal to warehouse</span></div>
      <div>Carry <span id="cartCarry" class="green">200</span> <span class="muted">‚Ä¢</span> Speed <span id="cartSpeed" class="blue">200</span></div>
      <div class="compact muted">Cycles automatically; each trip moves up to ‚ÄúCarry‚Äù.</div>
    </div>
    <div class="card">
      <div class="big">Crusher (Bottom Track) <span class="muted">Ore ‚Üí Chunks</span></div>
      <div>Rate: <span id="crusherRate" class="green">0/s</span> <span id="crusherStatus" class="green">‚Ä¢ Crunching!</span></div>
    </div>
    <div class="card">
      <div class="big">Smelter <span class="muted">Chunks ‚Üí Ingots</span></div>
      <div>Cycle: <span id="smeltCycle" class="green">0.0s</span> <span id="smeltStatus" class="green">‚Ä¢ Glowing!</span></div>
    </div>
    <div class="card">
      <div class="big">Warehouse <span class="muted">Stores Coal & Ingots</span></div>
      <div>Cap: <span id="whCap" class="blue">0</span> <span class="muted">‚Ä¢</span> Coal <span id="whCoal" class="green">0</span> <span class="muted">‚Ä¢</span> Ingots <span id="whIngots" class="green">0</span></div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btnGreen" id="btnSell100Coal">Sell 100 Coal</button>
        <button class="btnGreen" id="btnSellAllCoal">Sell All Coal</button>
        <button class="btnGreen" id="btnSell10Ingots">Sell 10 Ingots (+80)</button>
        <button class="btnGreen" id="btnSellAllIngots">Sell All Ingots</button>
      </div>
    </div>
    <h2>Upgrades</h2>
    <div class="grid2">
      <div class="card">
        <div class="big">ü™õ Drill Power</div>
        <div class="muted">x1.15 / level ‚Äî L <span id="lvlDrill">0</span></div>
        <div>Cost: <span id="costDrill" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyDrill">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üè≠ Warehouse Size</div>
        <div class="muted">+60 cap ‚Äî L <span id="lvlWarehouse">0</span></div>
        <div>Cost: <span id="costWarehouse" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyWarehouse">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üõí Cart Carry</div>
        <div class="muted">+20 ‚Äî L <span id="lvlCarry">0</span></div>
        <div>Cost: <span id="costCarry" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyCarry">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üí® Cart Speed</div>
        <div class="muted">+18 ‚Äî L <span id="lvlSpeed">0</span></div>
        <div>Cost: <span id="costSpeed" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buySpeed">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üßä Crusher Speed</div>
        <div class="muted">+0.18/s ‚Äî L <span id="lvlCrusher">0</span></div>
        <div>Cost: <span id="costCrusher" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyCrusher">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üî• Smelter Heat</div>
        <div class="muted">Faster cycles ‚Äî L <span id="lvlSmelter">0</span></div>
        <div>Cost: <span id="costSmelter" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buySmelter">Buy</button></div>
      </div>
    </div>
    <h2>Workers</h2>
    <div class="card">
      <div class="big">üßë‚Äçüè≠ Miners</div>
      <div>Each adds <b>8%</b> to both coal & ore</div>
      <div>Crew size: <span id="crewSize" class="green">0</span></div>
      <div>Hire cost: <span id="hireCost" class="green">0</span></div>
      <div style="margin-top:8px"><button class="btnGreen" id="btnHire">Hire</button></div>
    </div>
    <h2>Contracts</h2>
    <div class="card">
      <div>Offer: Deliver <b id="contractNeed">0</b> ingot in <b id="contractTime">0m</b></div>
      <div>Pay: <span id="contractPay" class="green">0</span> ‚Ä¢ Speed bonus: +25%</div>
      <div class="muted">Miss it: ‚àí10% coins</div>
      <div class="row" style="margin-top:8px">
        <button class="btnGreen" id="btnAcceptContract">Accept</button>
        <button id="btnDeliverNow">Deliver Now</button>
        <span class="chip" id="contractStatus">No contract</span>
      </div>
    </div>
    <h2>Quests</h2>
    <div class="card">
      <div id="quests"></div>
      <div style="margin-top:8px" class="muted">Your Stickers: <span id="stickers"></span></div>
    </div>
    <div class="card" style="margin:20px 12px">
      <div class="muted">Made for Timmy RedHat. <a href="#" onclick="localStorage.clear();location.reload();return false;">Reset save</a></div>
    </div>
  </aside>
</div>
<script>
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function formatNum(v){if(v<1000)return Math.round(v).toString();const u=["K","M","B","T"];let i=-1;while(v>=1000&&i<u.length-1){v/=1000;i++}return v.toFixed(1)+u[i]}
const GAME={money:120,miners:5,upgrades:{drill:7,warehouse:1,carry:8,speed:4,crusher:0,smelter:0},stock:{mineCoal:0,mineOre:0,chunks:0,whCoal:0,whIngots:0},warehouseCapBase:240,cart:{baseCarry:200,baseSpeed:140,distance:600,t:0,carrying:0},smelter:{timer:0},contract:{active:false,need:30,pay:520,deadline:0},stickers:[],quests:[{id:"q1",name:"Collect 100 Coal",type:"coal",target:100,reward:100,sticker:"üßä Coal Champ",done:false},{id:"q2",name:"Smelt 1 Ingot",type:"ingot",target:1,reward:120,sticker:"üî• Smelter Star",done:false}],totals:{coalCollected:0,ingotsSmelted:0}};
function prodMult(){const minersBoost=1+GAME.miners*0.08;const drillBoost=Math.pow(1.15,GAME.upgrades.drill);return minersBoost*drillBoost}
function coalRate(){return 2*prodMult()}
function oreRate(){return 1.2*prodMult()}
function crusherRate(){return .36+GAME.upgrades.crusher*.18}
function smeltCycle(){return 2.8/(1+GAME.upgrades.smelter*.12)}
function cartCarry(){return GAME.cart.baseCarry+GAME.upgrades.carry*20}
function cartSpeed(){return GAME.cart.baseSpeed+GAME.upgrades.speed*18}
function warehouseCap(){return GAME.warehouseCapBase+GAME.upgrades.warehouse*60}
function sellCoal(n){const amt=Math.min(n,GAME.stock.whCoal);GAME.stock.whCoal-=amt;GAME.money+=amt*.2}
function sellAllCoal(){sellCoal(GAME.stock.whCoal)}
function sellIngots(n){const amt=Math.min(n,GAME.stock.whIngots);GAME.stock.whIngots-=amt;GAME.money+=amt*8}
function sellAllIngots(){sellIngots(GAME.stock.whIngots)}
function upgradeCost(kind,lvl){const bases={drill:90,warehouse:60,carry:120,speed:110,crusher:90,smelter:120};const growth={drill:1.25,warehouse:1.22,carry:1.25,speed:1.25,crusher:1.25,smelter:1.25};return Math.round(bases[kind]*Math.pow(growth[kind],lvl))}
function tryBuy(kind){const lvl=GAME.upgrades[kind];const cost=upgradeCost(kind,lvl);if(GAME.money<cost)return;GAME.money-=cost;GAME.upgrades[kind]=lvl+1}
function hireCost(){return Math.round(110*Math.pow(1.25,GAME.miners))}
function tryHire(){const c=hireCost();if(GAME.money<c)return;GAME.money-=c;GAME.miners++}
function newOffer(){const need=20+Math.floor(Math.random()*25);const minutes=5+Math.floor(Math.random()*6);const pay=300+need*10;return{need,minutes,pay}}
let currentOffer=newOffer();
function acceptContract(){if(GAME.contract.active)return;GAME.contract.active=true;GAME.contract.need=currentOffer.need;GAME.contract.pay=currentOffer.pay;GAME.contract.deadline=performance.now()+currentOffer.minutes*60000;setStatus("contractStatus","Accepted")}
function deliverNow(){if(!GAME.contract.active)return;if(GAME.stock.whIngots>=GAME.contract.need){GAME.stock.whIngots-=GAME.contract.need;GAME.money+=Math.round(GAME.contract.pay*1.25);GAME.contract.active=false;setStatus("contractStatus","Delivered!");currentOffer=newOffer()}else{setStatus("contractStatus","Need "+(GAME.contract.need-GAME.stock.whIngots)+" more")}}
function checkQuests(){for(const q of GAME.quests){if(q.done)continue;const progress=q.type==="coal"?GAME.totals.coalCollected:q.type==="ingot"?GAME.totals.ingotsSmelted:0;if(progress>=q.target){q.done=true;GAME.money+=q.reward;GAME.stickers.push(q.sticker)}}}
function $(id){return document.getElementById(id)}
function setStatus(id,text){$(id).textContent=text}
$("btnSell100Coal").onclick=()=>{sellCoal(100)};
$("btnSellAllCoal").onclick=()=>{sellAllCoal()};
$("btnSell10Ingots").onclick=()=>{sellIngots(10)};
$("btnSellAllIngots").onclick=()=>{sellAllIngots()};
$("buyDrill").onclick=()=>{tryBuy("drill")};
$("buyWarehouse").onclick=()=>{tryBuy("warehouse")};
$("buyCarry").onclick=()=>{tryBuy("carry")};
$("buySpeed").onclick=()=>{tryBuy("speed")};
$("buyCrusher").onclick=()=>{tryBuy("crusher")};
$("buySmelter").onclick=()=>{tryBuy("smelter")};
$("btnHire").onclick=()=>{tryHire()};
$("btnAcceptContract").onclick=()=>{acceptContract()};
$("btnDeliverNow").onclick=()=>{deliverNow()};
function refreshUI(now){
  $("hudMoney").textContent=formatNum(GAME.money);
  $("hudCoal").textContent=formatNum(GAME.stock.whCoal);
  $("hudOre").textContent=formatNum(GAME.stock.mineOre);
  $("hudChunks").textContent=formatNum(GAME.stock.chunks);
  $("hudIngots").textContent=formatNum(GAME.stock.whIngots);
  $("mineCoalRate").textContent=coalRate().toFixed(2)+"/s";
  $("mineOreRate").textContent=oreRate().toFixed(2)+"/s";
  $("cartCarry").textContent=cartCarry();
  $("cartSpeed").textContent=cartSpeed();
  $("crusherRate").textContent=crusherRate().toFixed(2)+"/s";
  $("smeltCycle").textContent=smeltCycle().toFixed(2)+"s";
  $("whCap").textContent=warehouseCap();
  $("whCoal").textContent=formatNum(GAME.stock.whCoal);
  $("whIngots").textContent=formatNum(GAME.stock.whIngots);
  $("lvlDrill").textContent=GAME.upgrades.drill;
  $("costDrill").textContent=upgradeCost("drill",GAME.upgrades.drill);
  $("lvlWarehouse").textContent=GAME.upgrades.warehouse;
  $("costWarehouse").textContent=upgradeCost("warehouse",GAME.upgrades.warehouse);
  $("lvlCarry").textContent=GAME.upgrades.carry;
  $("costCarry").textContent=upgradeCost("carry",GAME.upgrades.carry);
  $("lvlSpeed").textContent=GAME.upgrades.speed;
  $("costSpeed").textContent=upgradeCost("speed",GAME.upgrades.speed);
  $("lvlCrusher").textContent=GAME.upgrades.crusher;
  $("costCrusher").textContent=upgradeCost("crusher",GAME.upgrades.crusher);
  $("lvlSmelter").textContent=GAME.upgrades.smelter;
  $("costSmelter").textContent=upgradeCost("smelter",GAME.upgrades.smelter);
  $("crewSize").textContent=GAME.miners;
  $("hireCost").textContent=hireCost();
  if(!GAME.contract.active){
    $("contractNeed").textContent=currentOffer.need;
    $("contractTime").textContent=currentOffer.minutes+"m";
    $("contractPay").textContent=currentOffer.pay;
  }else{
    const left=Math.max(0,GAME.contract.deadline-now);
    $("contractNeed").textContent=GAME.contract.need;
    $("contractTime").textContent=(left/60000).toFixed(1)+"m";
    $("contractPay").textContent=GAME.contract.pay;
    if(left<=0){
      GAME.contract.active=false;
      const loss=Math.round(GAME.money*.10);
      GAME.money=Math.max(0,GAME.money-loss);
      setStatus("contractStatus","Missed (‚àí"+loss+")");
      currentOffer=newOffer();
    }
  }
  const qWrap=$("quests");
  qWrap.innerHTML="";
  for(const q of GAME.quests){
    const el=document.createElement("div");
    el.className="card";
    el.style.margin="8px 0 0";
    el.innerHTML=`<div class="row"><div class="big">${q.name}</div><div>${q.done?'<span class="green">Done ‚úì</span>': ''}</div></div><div class="muted">Reward: +${q.reward} coins ‚Ä¢ Sticker: ${q.sticker}</div>`;
    qWrap.appendChild(el)
  }
  $("stickers").textContent=GAME.stickers.join("  ");
}
function updateChain(dt,now){
  const addCoal=coalRate()*dt;
  const addOre=oreRate()*dt;
  GAME.stock.mineCoal+=addCoal;
  GAME.stock.mineOre+=addOre;
  GAME.totals.coalCollected+=addCoal;
  const loadRate=cartCarry()*0.5;
  if(CART.phase==="load"){
    const need=Math.max(0,cartCarry()-CART.carrying);
    const load=Math.min(need,GAME.stock.mineCoal,loadRate*dt);
    if(load>0){GAME.stock.mineCoal-=load;CART.carrying+=load}
    if(CART.carrying>=cartCarry()-0.001){CART.carrying=Math.min(CART.carrying,cartCarry());CART.phase="toWH"}
  }else if(CART.phase==="toWH"){
    const v=(cartSpeed()/140)*dt/Math.max(0.001,PATH.len);
    CART.pos=Math.min(1,CART.pos+v);
    if(CART.pos>=1){CART.phase="unload"}
  }else if(CART.phase==="unload"){
    let free=warehouseCap()-(GAME.stock.whCoal+GAME.stock.whIngots);
    const moved=Math.min(CART.carrying,free);
    if(moved>0){GAME.stock.whCoal+=moved;CART.carrying-=moved}
    if(CART.carrying<=0.001){CART.carrying=0;CART.phase="toMine"}
  }else if(CART.phase==="toMine"){
    const v=(cartSpeed()/140)*dt/Math.max(0.001,PATH.len);
    CART.pos=Math.max(0,CART.pos-v);
    if(CART.pos<=0){CART.phase="load"}
  }
  const crush=Math.min(GAME.stock.mineOre,crusherRate()*dt);
  GAME.stock.mineOre-=crush;
  GAME.stock.chunks+=crush;
  $("crusherStatus").style.visibility=crush>0?"visible":"hidden";
  GAME.smelter.timer+=dt;
  if(GAME.smelter.timer>=smeltCycle()){
    GAME.smelter.timer=0;
    if(GAME.stock.chunks>=1){
      const free2=warehouseCap()-(GAME.stock.whCoal+GAME.stock.whIngots);
      if(free2>=1){
        GAME.stock.chunks-=1;
        GAME.stock.whIngots+=1;
        GAME.totals.ingotsSmelted+=1;
        $("smeltStatus").style.visibility="visible";
      }else{
        $("smeltStatus").style.visibility="hidden";
      }
    }else{
      $("smeltStatus").style.visibility="hidden";
    }
  }
  checkQuests();
}
const TILE_W=96,TILE_H=48,DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const canvas=$("canvas"),ctx=canvas.getContext("2d");
const CAM={x:-250,y:-200,z:1,drag:false,lx:0,ly:0};
function isoToScreen(ix,iy,iz=0){return{x:(ix-iy)*(TILE_W/2),y:(ix+iy)*(TILE_H/2)-iz}}
const stage=document.querySelector(".stage");
function resize(){const rect=stage.getBoundingClientRect();const w=Math.floor(rect.width*DPR),h=Math.floor(rect.height*DPR);canvas.width=w;canvas.height=h;canvas.style.width=rect.width+"px";canvas.style.height=rect.height+"px";ctx.setTransform(DPR,0,0,DPR,0,0)}
window.addEventListener("resize",resize);resize();
canvas.addEventListener("mousedown",e=>{CAM.drag=true;CAM.lx=e.clientX;CAM.ly=e.clientY});
window.addEventListener("mouseup",()=>CAM.drag=false);
window.addEventListener("mousemove",e=>{if(!CAM.drag)return;CAM.x+=e.clientX-CAM.lx;CAM.y+=e.clientY-CAM.ly;CAM.lx=e.clientX;CAM.ly=e.clientY});
canvas.addEventListener("wheel",e=>{const s=Math.exp(-e.deltaY*.001);const old=CAM.z;CAM.z=clamp(CAM.z*s,.5,2.25);const r=canvas.getBoundingClientRect();const mx=e.clientX-(r.left+r.width/2);const my=e.clientY-(r.top+r.height/2);CAM.x=mx-(mx-CAM.x)*(CAM.z/old);CAM.y=my-(my-CAM.y)*(CAM.z/old)},{passive:true});
const trees=[];
const buildings=[
  {id:"mine",x:0,y:0,w:3,h:3,H:42,label:"Mine",color:"#c5d4e8"},
  {id:"crusher",x:10,y:3,w:3,h:2,H:36,label:"Crusher",color:"#b7c7dd"},
  {id:"smelter",x:13,y:2,w:3,h:2,H:48,label:"Smelter",color:"#b2d6c7"},
  {id:"warehouse",x:0,y:10,w:6,h:4,H:36,label:"Warehouse",color:"#f0cfa6"},
  {id:"office",x:12,y:6,w:2,h:2,H:40,label:"HQ",color:"#e2b7cc"}
]; 
function byId(id){return buildings.find(b=>b.id===id)}
const DOCKS=(()=>{const m=byId("mine"),w=byId("warehouse");const mDock={x:m.x+m.w+0.1,y:m.y+m.h*0.5};const wDock={x:w.x-0.2,y:w.y+w.h*0.5};return{mDock,wDock}})();
const PATH=(()=>{const d=DOCKS;const dx=d.wDock.x-d.mDock.x,dy=d.wDock.y-d.mDock.y;const len=Math.hypot(dx,dy)||1;return{a:d.mDock,b:d.wDock,dx,dy,len}})();
const CART={phase:"load",pos:0,carrying:0};
const tileTex=(()=>{const c=document.createElement("canvas");c.width=TILE_W;c.height=TILE_H;const g=c.getContext("2d");g.translate(TILE_W/2,TILE_H/2);g.beginPath();g.moveTo(0,-TILE_H/2);g.lineTo(TILE_W/2,0);g.lineTo(0,TILE_H/2);g.lineTo(-TILE_W/2,0);g.closePath();const grd=g.createLinearGradient(-TILE_W/2,0,TILE_W/2,0);grd.addColorStop(0,"#d7e2f1");grd.addColorStop(1,"#f3f7ff");g.fillStyle=grd;g.fill();g.strokeStyle="rgba(0,0,0,0.06)";g.stroke();return c})();
function shadow(g,x,y,w,d){g.save();g.globalAlpha=.2;g.fillStyle="#000";g.beginPath();g.ellipse(x,y+8,w,d,0,0,Math.PI*2);g.fill();g.restore()}
function drawTree(g,ix,iy,t){const p=isoToScreen(ix,iy,0);shadow(g,p.x,p.y,12,6);const sway=Math.sin(t+ix*13.3+iy*7.1)*2;g.save();g.translate(p.x,p.y-16);g.fillStyle="#2e8f42";g.beginPath();g.moveTo(0,-24+sway);g.lineTo(8,-6+sway);g.lineTo(-8,-6+sway);g.closePath();g.fill();g.fillStyle="#206e32";g.beginPath();g.moveTo(0,-16+sway);g.lineTo(7,-2+sway);g.lineTo(-7,-2+sway);g.closePath();g.fill();g.fillStyle="#1a5a29";g.beginPath();g.moveTo(0,-8+sway);g.lineTo(6,2+sway);g.lineTo(-6,2+sway);g.closePath();g.fill();g.restore()}
function lighten(c,f){const n=parseInt(c.slice(1),16);let r=(n>>16)&255,g=(n>>8)&255,b=n&255;r=Math.min(255,Math.max(0,Math.round(r+(255-r)*f)));g=Math.min(255,Math.max(0,Math.round(g+(255-g)*f)));b=Math.min(255,Math.max(0,Math.round(b+(255-b)*f)));return"#"+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1)}
function darken(c,f){return lighten(c,-f)}
function drawFootprint(g,x,y,w,h,color){const pts=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y+h,0),isoToScreen(x,y+h,0)];g.fillStyle=color||"#e6ecf8";g.beginPath();g.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)g.lineTo(pts[i].x,pts[i].y);g.closePath();g.fill();g.strokeStyle="rgba(0,0,0,0.08)";g.stroke()}
function drawDirtFootprint(g,x,y,w,h){const pts=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y+h,0),isoToScreen(x,y+h,0)];g.save();g.beginPath();g.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)g.lineTo(pts[i].x,pts[i].y);g.closePath();const c=isoToScreen(x+w/2,y+h/2,0);const rad=Math.max(TILE_W*w,TILE_H*h)*1.6;const grd=g.createRadialGradient(c.x,c.y,8,c.x,c.y,rad);grd.addColorStop(0,"#6b5a4a");grd.addColorStop(.6,"#4b4541");grd.addColorStop(1,"#1e1e1e");g.fillStyle=grd;g.fill();g.clip();for(let i=0;i<220;i++){const rx=-0.2+Math.random()*(w+0.4);const ry=-0.2+Math.random()*(h+0.4);const p=isoToScreen(x+rx,y+ry,0);g.globalAlpha=.15+.25*Math.random();g.fillStyle=["#3a312b","#59524a","#2a2a2a","#444444"][Math.floor(Math.random()*4)];g.fillRect(p.x,p.y,1+Math.random()*2,.8+Math.random()*1.6)}g.globalAlpha=1;g.restore();g.strokeStyle="rgba(0,0,0,0.12)";g.beginPath();g.moveTo(pts[0].x,pts[0].y);for(let i=1;i<pts.length;i++)g.lineTo(pts[i].x,pts[i].y);g.closePath();g.stroke()}
function wallsOnly(g,x,y,w,h,H,col){
  const p=[isoToScreen(x,y,H),isoToScreen(x+w,y,H),isoToScreen(x+w,y+h,H),isoToScreen(x,y+h,H)];
  const b=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y+h,0),isoToScreen(x,y+h,0)];
  g.fillStyle=darken(col,.12);
  g.beginPath(); g.moveTo(p[0].x,p[0].y); g.lineTo(p[1].x,p[1].y); g.lineTo(b[1].x,b[1].y); g.lineTo(b[0].x,b[0].y); g.closePath(); g.fill();
  g.fillStyle=darken(col,.18);
  g.beginPath(); g.moveTo(p[1].x,p[1].y); g.lineTo(b[1].x,b[1].y); g.lineTo(b[2].x,b[2].y); g.lineTo(p[2].x,p[2].y); g.closePath(); g.fill();
  g.fillStyle=darken(col,.08);
  g.beginPath(); g.moveTo(p[0].x,p[0].y); g.lineTo(b[0].x,b[0].y); g.lineTo(b[3].x,b[3].y); g.lineTo(p[3].x,p[3].y); g.closePath(); g.fill();
}
function box(g,x,y,w,h,H,col){const p=[isoToScreen(x,y,H),isoToScreen(x+w,y,H),isoToScreen(x+w,y+h,H),isoToScreen(x,y+h,H)];const b=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x,y+h,0),isoToScreen(x,y+h,0)];g.fillStyle=darken(col,.18);g.beginPath();g.moveTo(p[1].x,p[1].y);g.lineTo(b[1].x,b[1].y);g.lineTo(b[2].x,b[2].y);g.lineTo(p[2].x,p[2].y);g.closePath();g.fill();g.fillStyle=darken(col,.08);g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(b[0].x,b[0].y);g.lineTo(b[3].x,b[3].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill();g.fillStyle=lighten(col,.06);g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(p[1].x,p[1].y);g.lineTo(p[2].x,p[2].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill();g.strokeStyle="rgba(0,0,0,0.1)";g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(p[1].x,p[1].y);g.lineTo(p[2].x,p[2].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.stroke()}
function label(g,x,y,t){g.save();g.font="12px Inter,system-ui,Arial";g.textAlign="center";g.fillStyle="rgba(0,0,0,.8)";g.fillText(t,x,y);g.restore()}
function getPrismPoints(x,y,w,h,H){const p=[isoToScreen(x,y,H),isoToScreen(x+w,y,H),isoToScreen(x+w,y+h,H),isoToScreen(x,y+h,H)];const b=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y,h=0),isoToScreen(x,y+h,0)];return{p,b}}
function wallQuad(x,y,w,h,H,side,rx0,rx1,ry0,ry1){const{p,b}=getPrismPoints(x,y,w,h,H);const idx=side==='right'?[1,2,1]:[0,3,0];const bs=b[idx[0]],be=b[idx[1]],ps=p[idx[2]];const vx={x:be.x-bs.x,y:be.y-bs.y};const vy={x:ps.x-bs.x,y:ps.y-bs.y};const q00={x:bs.x+vx.x*rx0+vy.x*ry0,y:bs.y+vx.y*rx0+vy.y*ry0};const q10={x:bs.x+vx.x*rx1+vy.x*ry0,y:bs.y+vx.y*rx1+vy.y*ry0};const q11={x:bs.x+vx.x*rx1+vy.x*ry1,y:bs.y+vx.y*rx1+vy.y*ry1};const q01={x:bs.x+vx.x*rx0+vy.x*ry1,y:bs.y+vx.y*rx0+vy.y*ry1};return[q00,q10,q11,q01]}
const BOULDER_COLORS=["#9aa3ad","#7c848c","#6b6f70","#b3a898","#8a7a65"];
function randSeeded(seed){let s=seed>>>0;return()=>((s=s*1664525+1013904223>>>0)/4294967296)}
function ensureMineBoulders(bld){
  if(bld._boulders)return;
  const seed=((bld.x*73856093)^(bld.y*19349663)^(bld.w*83492791))>>>0;
  const R=randSeeded(seed);
  const baseCount=80+Math.floor(R()*60);
  bld._boulders=[];
  for(let i=0;i<baseCount;i++){
    const ox=-.6+R()*(bld.w+1.2);
    const oy=-.4+R()*(bld.h+1.2);
    const size=2+Math.pow(R(),1.25)*10;
    const base=BOULDER_COLORS[Math.floor(R()*BOULDER_COLORS.length)];
    bld._boulders.push({x:bld.x+ox,y:bld.y+oy,r:size,c:base});
  }
  bld._boulders.sort((a,b)=>b.r-a.r);
  bld._boulders.splice(0,3);
  const extra=40+Math.floor(R()*40);
  for(let k=0;k<extra;k++){
    const ox=-.6+R()*(bld.w+1.2);
    const oy=-.4+R()*(bld.h+1.2);
    const size=1.5+Math.pow(R(),1.6)*8;
    const base=BOULDER_COLORS[Math.floor(R()*BOULDER_COLORS.length)];
    bld._boulders.push({x:bld.x+ox,y:bld.y+oy,r:size,c:base});
  }
}
function drawBoulder(g,ix,iy,r,col){const p=isoToScreen(ix,iy,0);shadow(g,p.x,p.y,r*.9,r*.5);g.save();g.translate(p.x,p.y-2);g.fillStyle=col;g.beginPath();g.ellipse(0,-r*.35,r,r*.7,0,0,Math.PI*2);g.fill();g.globalAlpha=.35;g.fillStyle=darken(col,.25);g.beginPath();g.ellipse(-r*.25,-r*.25,r*.65,r*.55,0,0,Math.PI*2);g.fill();g.globalAlpha=.25;g.fillStyle="#ffffff";g.beginPath();g.ellipse(r*.25,-r*.55,r*.35,r*.25,0,0,Math.PI*2);g.fill();g.globalAlpha=1;g.restore()}
function drawMine(g,bld){drawDirtFootprint(g,bld.x,bld.y,bld.w,bld.h);ensureMineBoulders(bld);for(const r of bld._boulders){drawBoulder(g,r.x,r.y,r.r,r.c)}}
function drawWarehouse(g,bld){drawFootprint(g,bld.x,bld.y,bld.w,bld.h,"#f3e9d3");const col="#e8d5b5";wallsOnly(g,bld.x,bld.y,bld.w,bld.h,bld.H,col);const door=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.12,.72,.02,.55);g.fillStyle="#2a2e36";g.beginPath();g.moveTo(door[0].x,door[0].y);for(let i=1;i<door.length;i++)g.lineTo(door[i].x,door[i].y);g.closePath();g.fill();g.strokeStyle="rgba(255,255,255,0.25)";g.lineWidth=1;for(let t=.1;t<.5;t+=.08){const q=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.12,.72,t,t);g.beginPath();g.moveTo(q[0].x,q[0].y);g.lineTo(q[1].x,q[1].y);g.stroke()}const gx=Math.max(1,Math.floor(bld.w*2));const gy=Math.max(1,Math.floor(bld.h*2));const boxPer=50;const maxBoxes=gx*gy;const boxes=Math.min(maxBoxes,Math.floor(GAME.stock.whCoal/boxPer));let n=0;for(let iy=0;iy<gy;iy++){for(let ix=0;ix<gx;ix++){if(n>=boxes)break;const cx=bld.x+0.2+ix*0.5;const cy=bld.y+0.2+iy*0.5;drawCrate(g,cx,cy);n++}}}
function drawHQ(g,bld){drawFootprint(g,bld.x,bld.y,bld.w,bld.h,"#eaf0fb");const col="#aac1e9";wallsOnly(g,bld.x,bld.y,bld.w,bld.h,bld.H,col);g.fillStyle="#e9f4ff";const winR=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.18,.30,.20,.32);const winR2=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.45,.57,.20,.32);const winL=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'left',.18,.30,.20,.32);[winR,winR2,winL].forEach(q=>{g.beginPath();g.moveTo(q[0].x,q[0].y);for(let i=1;i<q.length;i++)g.lineTo(q[i].x,q[i].y);g.closePath();g.fill()});const plaque=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.32,.42,.05,.18);g.fillStyle="rgba(0,0,0,0.7)";g.beginPath();g.moveTo(plaque[0].x,plaque[0].y);for(let i=1;i<plaque.length;i++)g.lineTo(plaque[i].x,plaque[i].y);g.closePath();g.fill();g.fillStyle="#fff";g.font="10px Inter,system-ui,Arial";g.textAlign="center";const cx=(plaque[0].x+plaque[2].x)/2,cy=(plaque[0].y+plaque[2].y)/2+3;g.fillText("HQ",cx,cy)}
function drawCrusher(g,bld){drawFootprint(g,bld.x,bld.y,bld.w,bld.h,"#e7ecf5");const col="#9fb0c8";wallsOnly(g,bld.x,bld.y,bld.w,bld.h,bld.H,col);const mouth=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.18,.80,.15,.65);g.fillStyle="#1f2430";g.beginPath();g.moveTo(mouth[0].x,mouth[0].y);g.lineTo(mouth[1].x,mouth[1].y);g.lineTo(mouth[2].x,mouth[2].y);g.lineTo(mouth[3].x,mouth[3].y);g.closePath();g.fill();g.strokeStyle="#cfd6e0";g.lineWidth=2;for(let i=0;i<4;i++){const t0=i*.15+.22;const t1=t0+.08;const q=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',t0,t1,.15,.65);g.beginPath();g.moveTo(q[0].x,q[0].y);g.lineTo(q[2].x,q[2].y);g.stroke()}}
function drawSmelter(g,bld,now){drawFootprint(g,bld.x,bld.y,bld.w,bld.h,"#efe7db");const col="#c0b099";wallsOnly(g,bld.x,bld.y,bld.w,bld.h,bld.H,col);const mouth=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.25,.60,.25,.55);const grd=ctx.createLinearGradient(mouth[0].x,mouth[0].y,mouth[2].x,mouth[2].y);grd.addColorStop(0,"#23160e");grd.addColorStop(1,"#ffb46b");g.fillStyle=grd;g.beginPath();g.moveTo(mouth[0].x,mouth[0].y);for(let i=1;i<mouth.length;i++)g.lineTo(mouth[i].x,mouth[i].y);g.closePath();g.fill();const pulse=(Math.sin(now*.004)+1)/2;g.globalAlpha=.35+.25*pulse;g.fillStyle="#ffdd8a";const inner=wallQuad(bld.x,bld.y,bld.w,bld.h,bld.H,'right',.32,.53,.33,.49);g.beginPath();g.moveTo(inner[0].x,inner[0].y);for(let i=1;i<inner.length;i++)g.lineTo(inner[i].x,inner[i].y);g.closePath();g.fill();g.globalAlpha=1}
function drawCrate(g,x,y){const H=12,w=.45,h=.45;const p=[isoToScreen(x,y,H),isoToScreen(x+w,y,H),isoToScreen(x+w,y+h,H),isoToScreen(x,y+h,H)];const b=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y+h,0),isoToScreen(x,y+h,0)];g.fillStyle="#b48a55";g.beginPath();g.moveTo(p[1].x,p[1].y);g.lineTo(b[1].x,b[1].y);g.lineTo(b[2].x,b[2].y);g.lineTo(p[2].x,p[2].y);g.closePath();g.fill();g.fillStyle="#c5965c";g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(b[0].x,b[0].y);g.lineTo(b[3].x,b[3].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill();g.fillStyle="#d8b27a";g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(p[1].x,p[1].y);g.lineTo(p[2].x,p[2].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill()}
function drawBuilding(g,bld,now){switch(bld.id){case"mine":drawMine(g,bld);break;case"warehouse":drawWarehouse(g,bld);break;case"office":drawHQ(g,bld);break;case"crusher":drawCrusher(g,bld);break;case"smelter":drawSmelter(g,bld,now);break;default:box(g,bld.x,bld.y,bld.w,bld.h,bld.H,bld.color)}}
function minerSprite(g,m,t){const p=isoToScreen(m.x,m.y,0);shadow(g,p.x,p.y,10,6);g.save();const bob=Math.sin(t*2+m.id.length)*1.2;g.translate(p.x,p.y-10+bob);g.fillStyle="#5b8bd4";g.fillRect(-5,-10,10,12);g.fillStyle="#f2c39b";g.beginPath();g.arc(0,-14,5,0,Math.PI*2);g.fill();if(m.id==="timmy"){g.fillStyle="#d7263d";g.fillRect(-6,-20,12,4);g.beginPath();g.moveTo(-6,-20);g.lineTo(0,-24);g.lineTo(6,-20);g.closePath();g.fill()}else{g.fillStyle="#333";g.fillRect(-6,-20,12,4)}g.save();g.translate(3,-8);g.rotate(-0.6+Math.sin(t*5+m.t*10)*0.9);g.fillStyle="#f2c39b";g.fillRect(-1,0,2,8);g.fillStyle="#7b5a3b";g.fillRect(-1,8,2,12);g.fillStyle="#cfd6e0";g.beginPath();g.moveTo(-12,18);g.lineTo(12,18);g.lineTo(0,20);g.closePath();g.fill();g.restore();g.fillStyle="#f2c39b";g.fillRect(-6,-8,2,8);g.restore()}
const miners=[{id:"timmy",x:0.6,y:0.6,t:Math.random(),speed:.7,carry:"coal"},{id:"m2",x:1.6,y:1.2,t:Math.random(),speed:.6,carry:"coal"},{id:"m3",x:2.2,y:0.8,t:Math.random(),speed:.65,carry:"ore"}];
function drawTrack(g){const a=isoToScreen(PATH.a.x,PATH.a.y,0),b=isoToScreen(PATH.b.x,PATH.b.y,0);g.save();g.strokeStyle="rgba(0,0,0,0.25)";g.lineWidth=6;g.beginPath();g.moveTo(a.x,a.y);g.lineTo(b.x,b.y);g.stroke();g.strokeStyle="rgba(60,60,60,0.8)";g.lineWidth=2;g.beginPath();g.moveTo(a.x,a.y);g.lineTo(b.x,b.y);g.stroke();g.restore()}
function drawCart(g){const t=CART.pos;const wx=PATH.a.x+PATH.dx*t,wy=PATH.a.y+PATH.dy*t;const p=isoToScreen(wx,wy,0);shadow(g,p.x,p.y,14,7);g.save();g.translate(p.x,p.y-6);g.fillStyle="#3a3f46";g.fillRect(-12,-8,24,14);if(CART.carrying>0){g.fillStyle="#2b2b2b";g.beginPath();g.ellipse(0,-6,10,4,0,0,Math.PI*2);g.fill()}g.fillStyle="#222";g.beginPath();g.arc(-8,8,4,0,Math.PI*2);g.arc(8,8,4,0,Math.PI*2);g.fill();g.restore()}
function renderIso(now){const cx=canvas.width/(2*DPR),cy=canvas.height/(2*DPR);ctx.save();ctx.translate(cx+CAM.x,cy+CAM.y);ctx.scale(CAM.z,CAM.z);for(let y=0;y<14;y++)for(let x=0;x<18;x++){const p=isoToScreen(x,y,0);ctx.drawImage(tileTex,p.x-TILE_W/2,p.y-TILE_H/2)}for(const t of trees){drawTree(ctx,t.x,t.y,now*.001+t.s)}drawTrack(ctx);for(const b of[...buildings].sort((a,b)=>(a.x+a.y)-(b.x+b.y))){drawBuilding(ctx,b,now)}for(const m of miners){minerSprite(ctx,m,now*.001+m.t)}drawCart(ctx);ctx.restore()}
let last=performance.now();
function tick(now){const dt=Math.min(.05,(now-last)/1000);last=now;updateChain(dt,now);refreshUI(now);ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);renderIso(now);requestAnimationFrame(tick)}
(function(){
  console.assert(!!document.getElementById("canvas"),"Canvas element not found");
  console.assert(Array.isArray(trees)&&trees.length===0,"trees array should be empty");
  console.assert(Array.isArray(buildings)&&buildings.length>0,"buildings should exist");
  const mineRef=buildings.find(b=>b.id==="mine");
  if(mineRef){ensureMineBoulders(mineRef);console.assert(mineRef._boulders&&mineRef._boulders.length>0,"mine should have boulders")}
  console.assert(typeof renderIso==="function","renderIso should be defined");
  ["hudCoal","hudOre","hudChunks","hudIngots","hudMoney","mineCoalRate","mineOreRate","cartCarry","cartSpeed","crusherRate","smeltCycle","whCap","whCoal","whIngots","lvlDrill","costDrill","lvlWarehouse","costWarehouse","lvlCarry","costCarry","lvlSpeed","costSpeed","lvlCrusher","costCrusher","lvlSmelter","costSmelter","crewSize","hireCost","contractNeed","contractTime","contractPay","quests","stickers"].forEach(id=>{console.assert(document.getElementById(id),id+" missing")});
  const wq=wallQuad(0,0,1,1,20,'right',0.1,0.2,0.1,0.2);console.assert(Array.isArray(wq)&&wq.length===4,"wallQuad output invalid");
  const testOrder=[{x:2,y:0},{x:0,y:3},{x:1,y:1}];
  const sumsPrev=[...testOrder].map(o=>o.x+o.y).sort((a,b)=>a-b);
  const sorted=[...testOrder].sort((a,b)=>(a.x+a.y)-(b.x+b.y));
  const sums=sorted.map(o=>o.x+o.y);
  console.assert(sums[0]<=sums[1]&&sums[1]<=sums[2],"building sort failed");
  console.assert(PATH.len>0,"path len");
  console.assert(CART.phase==="load","cart init");
  console.assert(typeof drawCart==="function"&&typeof drawTrack==="function","cart draw fns");
  const w=byId("warehouse");
  const gridMax=Math.max(1,Math.floor(w.w*2))*Math.max(1,Math.floor(w.h*2));
  console.assert(Number.isFinite(gridMax)&&gridMax>0,"crate grid calc");
})();
requestAnimationFrame(tick);
</script>
</body>
</html>
