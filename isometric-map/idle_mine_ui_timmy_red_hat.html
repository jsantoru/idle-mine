<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Idle Mine ‚Äì Timmy RedHat (Iso + UI)</title>
<style>
  :root{
    --bg:#0f1216; --panel:#171b22; --muted:#9bb0c3; --line:#242a33;
    --text:#eaf1f7; --accent:#86efac; --accent2:#7aa2ff; --warn:#f59e0b; --good:#34d399; --bad:#ef4444;
    --pill:#ffffffcc; --pillBorder: #00000010;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.4 Inter,system-ui,Segoe UI,Arial;overflow:hidden}
  .app{display:grid;grid-template-columns:minmax(0, 1fr) clamp(320px, 28vw, 420px);grid-template-rows:100vh}
  #canvas{display:block;width:100%;height:100%;background:#e9eef5}
  /* Top counters */
  #hud{position:fixed;top:14px;left:14px;display:flex;gap:10px;z-index:10;}
  .pill{backdrop-filter:blur(8px);background:var(--pill);border:1px solid var(--pillBorder);border-radius:14px;padding:8px 12px;color:#111;font-weight:600}
  .pill b{color:#000}
  /* Right UI */
  aside{height:100vh;overflow:auto;background:var(--panel);border-left:1px solid var(--line)}
  h2{margin:18px 16px 10px;font-size:22px}
  .card{margin:12px 12px 0;background:#10151c;border:1px solid var(--line);border-radius:12px;padding:14px}
  .row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .green{color:var(--good)} .blue{color:var(--accent2)} .warn{color:var(--warn)}
  button{background:#1a222c;border:1px solid #263040;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  button:disabled{opacity:.4;cursor:not-allowed}
  .btnGreen{background:#17321f;border-color:#1c3a25}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid2 .card{margin:0}
  .chip{display:inline-block;background:#0f1720;border:1px solid var(--line);padding:4px 8px;border-radius:8px;margin-right:6px}
  .compact{margin:4px 0 0;font-size:12px}
  .big{font-size:18px;font-weight:700}
  #legend{position:fixed;right:12px;bottom:12px;z-index:10;background:#ffffffcc;color:#111;border:1px solid #00000010;border-radius:10px;padding:8px 10px}
  a{color:#9dc1ff;text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <div class="stage">
    <div id="hud">
      <div class="pill">Coal: <b id="hudCoal">0</b></div>
      <div class="pill">Ore: <b id="hudOre">0</b></div>
      <div class="pill">Chunks: <b id="hudChunks">0</b></div>
      <div class="pill">Ingots: <b id="hudIngots">0</b></div>
      <div class="pill">$ <b id="hudMoney">0</b></div>
    </div>
    <canvas id="canvas"></canvas>
    <div id="legend">Drag = pan ¬∑ Wheel = zoom ¬∑ Timmy has the red hat ‚ù§</div>
  </div>

  <aside>
    <h2>Stations</h2>
    <div class="card">
      <div class="big">Mine <span class="muted">Coal + Ore</span></div>
      <div>Coal: <span id="mineCoalRate" class="green">0/s</span>
        <span class="muted">‚Ä¢</span> Ore: <span id="mineOreRate" class="blue">0/s</span></div>
    </div>

    <div class="card">
      <div class="big">Cart (Top Track) <span class="muted">Carries coal to warehouse</span></div>
      <div>Carry <span id="cartCarry" class="green">200</span> <span class="muted">‚Ä¢</span> Speed <span id="cartSpeed" class="blue">200</span></div>
      <div class="compact muted">Cycles automatically; each trip moves up to ‚ÄúCarry‚Äù.</div>
    </div>

    <div class="card">
      <div class="big">Crusher (Bottom Track) <span class="muted">Ore ‚Üí Chunks</span></div>
      <div>Rate: <span id="crusherRate" class="green">0/s</span> <span id="crusherStatus" class="green">‚Ä¢ Crunching!</span></div>
    </div>

    <div class="card">
      <div class="big">Smelter <span class="muted">Chunks ‚Üí Ingots</span></div>
      <div>Cycle: <span id="smeltCycle" class="green">0.0s</span> <span id="smeltStatus" class="green">‚Ä¢ Glowing!</span></div>
    </div>

    <div class="card">
      <div class="big">Warehouse <span class="muted">Stores Coal & Ingots</span></div>
      <div>Cap: <span id="whCap" class="blue">0</span>
        <span class="muted">‚Ä¢</span> Coal <span id="whCoal" class="green">0</span>
        <span class="muted">‚Ä¢</span> Ingots <span id="whIngots" class="green">0</span></div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btnGreen" id="btnSell100Coal">Sell 100 Coal</button>
        <button class="btnGreen" id="btnSellAllCoal">Sell All Coal</button>
        <button class="btnGreen" id="btnSell10Ingots">Sell 10 Ingots (+80)</button>
        <button class="btnGreen" id="btnSellAllIngots">Sell All Ingots</button>
      </div>
    </div>

    <h2>Upgrades</h2>
    <div class="grid2">
      <div class="card">
        <div class="big">ü™õ Drill Power</div>
        <div class="muted">x1.15 / level ‚Äî L <span id="lvlDrill">0</span></div>
        <div>Cost: <span id="costDrill" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyDrill">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üè≠ Warehouse Size</div>
        <div class="muted">+60 cap ‚Äî L <span id="lvlWarehouse">0</span></div>
        <div>Cost: <span id="costWarehouse" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyWarehouse">Buy</button></div>
      </div>

      <div class="card">
        <div class="big">üõí Cart Carry</div>
        <div class="muted">+20 ‚Äî L <span id="lvlCarry">0</span></div>
        <div>Cost: <span id="costCarry" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyCarry">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üí® Cart Speed</div>
        <div class="muted">+18 ‚Äî L <span id="lvlSpeed">0</span></div>
        <div>Cost: <span id="costSpeed" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buySpeed">Buy</button></div>
      </div>

      <div class="card">
        <div class="big">üßä Crusher Speed</div>
        <div class="muted">+0.18/s ‚Äî L <span id="lvlCrusher">0</span></div>
        <div>Cost: <span id="costCrusher" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buyCrusher">Buy</button></div>
      </div>
      <div class="card">
        <div class="big">üî• Smelter Heat</div>
        <div class="muted">Faster cycles ‚Äî L <span id="lvlSmelter">0</span></div>
        <div>Cost: <span id="costSmelter" class="green">0</span></div>
        <div style="margin-top:8px"><button class="btnGreen" id="buySmelter">Buy</button></div>
      </div>
    </div>

    <h2>Workers</h2>
    <div class="card">
      <div class="big">üßë‚Äçüè≠ Miners</div>
      <div>Each adds <b>8%</b> to both coal & ore</div>
      <div>Crew size: <span id="crewSize" class="green">0</span></div>
      <div>Hire cost: <span id="hireCost" class="green">0</span></div>
      <div style="margin-top:8px"><button class="btnGreen" id="btnHire">Hire</button></div>
    </div>

    <h2>Contracts</h2>
    <div class="card">
      <div>Offer: Deliver <b id="contractNeed">0</b> ingot in <b id="contractTime">0m</b></div>
      <div>Pay: <span id="contractPay" class="green">0</span> ‚Ä¢ Speed bonus: +25%</div>
      <div class="muted">Miss it: ‚àí10% coins</div>
      <div class="row" style="margin-top:8px">
        <button class="btnGreen" id="btnAcceptContract">Accept</button>
        <button id="btnDeliverNow">Deliver Now</button>
        <span class="chip" id="contractStatus">No contract</span>
      </div>
    </div>

    <h2>Quests</h2>
    <div class="card">
      <div id="quests"></div>
      <div style="margin-top:8px" class="muted">Your Stickers: <span id="stickers"></span></div>
    </div>

    <div class="card" style="margin:20px 12px">
      <div class="muted">Made for Timmy RedHat. <a href="#" onclick="localStorage.clear();location.reload();return false;">Reset save</a></div>
    </div>
  </aside>
</div>

<script>
/* ===========================================================
   UTILITIES
=========================================================== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
function formatNum(v){ if(v<1000) return Math.round(v).toString();
  const u=['K','M','B','T'];let i=-1; while(v>=1000&&i<u.length-1){v/=1000;i++}
  return v.toFixed(1)+u[i];
}

/* ===========================================================
   CORE GAME STATE
=========================================================== */
const GAME = {
  money: 120, // start coins
  miners: 5,  // crew size (each +8% production)
  upgrades: {
    drill: 7, warehouse: 1, carry: 8, speed: 4, crusher: 0, smelter: 0
  },
  // inventories across the chain
  stock: {
    mineCoal: 0, mineOre: 0, chunks: 0,
    whCoal: 0, whIngots: 0
  },
  // capacities / dynamics
  warehouseCapBase: 240, // +60 / level
  cart: { baseCarry:200, baseSpeed:140, distance:600, t:0, carrying:0 },
  smelter: { timer:0 },
  contract: { active:false, need:30, pay:520, deadline:0 },
  stickers: [],
  quests: [
    {id:'q1', name:'Collect 100 Coal', type:'coal', target:100, reward:100, sticker:'üßä Coal Champ', done:false},
    {id:'q2', name:'Smelt 1 Ingot', type:'ingot', target:1, reward:120, sticker:'üî• Smelter Star', done:false}
  ],
  totals: { coalCollected:0, ingotsSmelted:0 }
};

/* Derived numbers */
function prodMult(){
  const minersBoost = 1 + GAME.miners * 0.08;
  const drillBoost  = Math.pow(1.15, GAME.upgrades.drill);
  return minersBoost * drillBoost;
}
function coalRate(){ return 2.0 * prodMult(); }    // per second
function oreRate(){  return 1.2 * prodMult(); }    // per second
function crusherRate(){ return 0.36 + GAME.upgrades.crusher*0.18; } // ore->chunks / sec
function smeltCycle(){ return 2.8 / (1 + GAME.upgrades.smelter*0.12); } // seconds per ingot
function cartCarry(){ return GAME.cart.baseCarry + GAME.upgrades.carry*20; }
function cartSpeed(){ return GAME.cart.baseSpeed + GAME.upgrades.speed*18; } // abstract
function warehouseCap(){ return GAME.warehouseCapBase + GAME.upgrades.warehouse*60; }

/* ===========================================================
   ECONOMY (SELL)
=========================================================== */
function sellCoal(n){
  const amt = Math.min(n, GAME.stock.whCoal);
  GAME.stock.whCoal -= amt;
  GAME.money += amt * 0.2; // 20c each‚Äîtweak to taste
}
function sellAllCoal(){ sellCoal(GAME.stock.whCoal); }
function sellIngots(n){
  const amt = Math.min(n, GAME.stock.whIngots);
  GAME.stock.whIngots -= amt;
  GAME.money += amt * 8; // matches ‚ÄúSell 10 Ingots (+80)‚Äù
}
function sellAllIngots(){ sellIngots(GAME.stock.whIngots); }

/* ===========================================================
   UPGRADES / WORKERS
=========================================================== */
function upgradeCost(kind, lvl){
  const bases={drill:90, warehouse:60, carry:120, speed:110, crusher:90, smelter:120};
  const growth={drill:1.25, warehouse:1.22, carry:1.25, speed:1.25, crusher:1.25, smelter:1.25};
  return Math.round(bases[kind] * Math.pow(growth[kind], lvl));
}
function tryBuy(kind){
  const lvl = GAME.upgrades[kind];
  const cost = upgradeCost(kind, lvl);
  if(GAME.money < cost) return;
  GAME.money -= cost;
  GAME.upgrades[kind] = lvl + 1;
}
function hireCost(){ return Math.round(110 * Math.pow(1.25, GAME.miners)); }
function tryHire(){
  const c = hireCost();
  if(GAME.money < c) return;
  GAME.money -= c; GAME.miners++;
}

/* ===========================================================
   CONTRACTS
=========================================================== */
function newOffer(){
  const need = 20 + Math.floor(Math.random()*25);
  const minutes = 5 + Math.floor(Math.random()*6);
  const pay = 300 + need*10;
  return {need, minutes, pay};
}
let currentOffer = newOffer();

function acceptContract(){
  if(GAME.contract.active) return;
  GAME.contract.active = true;
  GAME.contract.need = currentOffer.need;
  GAME.contract.pay = currentOffer.pay;
  GAME.contract.deadline = performance.now() + currentOffer.minutes*60_000;
  setStatus('contractStatus', 'Accepted');
}
function deliverNow(){
  if(!GAME.contract.active) return;
  if(GAME.stock.whIngots >= GAME.contract.need){
    GAME.stock.whIngots -= GAME.contract.need;
    GAME.money += Math.round(GAME.contract.pay * 1.25); // speed bonus since instant
    GAME.contract.active = false;
    setStatus('contractStatus', 'Delivered!');
    currentOffer = newOffer();
  }else{
    setStatus('contractStatus', 'Need '+(GAME.contract.need - GAME.stock.whIngots)+' more');
  }
}

/* ===========================================================
   QUESTS
=========================================================== */
function checkQuests(){
  for(const q of GAME.quests){
    if(q.done) continue;
    const progress =
      q.type==='coal'  ? GAME.totals.coalCollected :
      q.type==='ingot' ? GAME.totals.ingotsSmelted : 0;
    if(progress >= q.target){
      q.done = true;
      GAME.money += q.reward;
      GAME.stickers.push(q.sticker);
    }
  }
}

/* ===========================================================
   UI BINDINGS
=========================================================== */
function $(id){ return document.getElementById(id); }
function setStatus(id, text){ $(id).textContent=text; }

$('btnSell100Coal').onclick = ()=>{ sellCoal(100); };
$('btnSellAllCoal').onclick = ()=>{ sellAllCoal(); };
$('btnSell10Ingots').onclick = ()=>{ sellIngots(10); };
$('btnSellAllIngots').onclick = ()=>{ sellAllIngots(); };

$('buyDrill').onclick = ()=>{ tryBuy('drill'); };
$('buyWarehouse').onclick = ()=>{ tryBuy('warehouse'); };
$('buyCarry').onclick = ()=>{ tryBuy('carry'); };
$('buySpeed').onclick = ()=>{ tryBuy('speed'); };
$('buyCrusher').onclick = ()=>{ tryBuy('crusher'); };
$('buySmelter').onclick = ()=>{ tryBuy('smelter'); };
$('btnHire').onclick = ()=>{ tryHire(); };

$('btnAcceptContract').onclick = ()=>{ acceptContract(); };
$('btnDeliverNow').onclick = ()=>{ deliverNow(); };

function refreshUI(now){
  // HUD
  $('hudMoney').textContent = formatNum(GAME.money);
  $('hudCoal').textContent  = formatNum(GAME.stock.whCoal);
  $('hudOre').textContent   = formatNum(GAME.stock.mineOre);
  $('hudChunks').textContent= formatNum(GAME.stock.chunks);
  $('hudIngots').textContent= formatNum(GAME.stock.whIngots);

  // Stations
  $('mineCoalRate').textContent = coalRate().toFixed(2)+'/s';
  $('mineOreRate').textContent  = oreRate().toFixed(2)+'/s';
  $('cartCarry').textContent    = cartCarry();
  $('cartSpeed').textContent    = cartSpeed();
  $('crusherRate').textContent  = crusherRate().toFixed(2)+'/s';
  $('smeltCycle').textContent   = smeltCycle().toFixed(2)+'s';
  $('whCap').textContent        = warehouseCap();
  $('whCoal').textContent       = formatNum(GAME.stock.whCoal);
  $('whIngots').textContent     = formatNum(GAME.stock.whIngots);

  // Upgrades / costs / levels
  $('lvlDrill').textContent     = GAME.upgrades.drill;
  $('costDrill').textContent    = upgradeCost('drill', GAME.upgrades.drill);
  $('lvlWarehouse').textContent = GAME.upgrades.warehouse;
  $('costWarehouse').textContent= upgradeCost('warehouse', GAME.upgrades.warehouse);
  $('lvlCarry').textContent     = GAME.upgrades.carry;
  $('costCarry').textContent    = upgradeCost('carry', GAME.upgrades.carry);
  $('lvlSpeed').textContent     = GAME.upgrades.speed;
  $('costSpeed').textContent    = upgradeCost('speed', GAME.upgrades.speed);
  $('lvlCrusher').textContent   = GAME.upgrades.crusher;
  $('costCrusher').textContent  = upgradeCost('crusher', GAME.upgrades.crusher);
  $('lvlSmelter').textContent   = GAME.upgrades.smelter;
  $('costSmelter').textContent  = upgradeCost('smelter', GAME.upgrades.smelter);

  // Hire
  $('crewSize').textContent = GAME.miners;
  $('hireCost').textContent = hireCost();

  // Contracts (offer/active)
  if(!GAME.contract.active){
    $('contractNeed').textContent = currentOffer.need;
    $('contractTime').textContent = currentOffer.minutes+'m';
    $('contractPay').textContent  = currentOffer.pay;
  }else{
    const left = Math.max(0, GAME.contract.deadline - now);
    $('contractNeed').textContent = GAME.contract.need;
    $('contractTime').textContent = (left/60000).toFixed(1)+'m';
    $('contractPay').textContent  = GAME.contract.pay;
    if(left<=0){ // failed
      GAME.contract.active=false;
      const loss = Math.round(GAME.money*0.10);
      GAME.money = Math.max(0, GAME.money - loss);
      setStatus('contractStatus','Missed (‚àí'+loss+')');
      currentOffer = newOffer();
    }
  }

  // Quests / stickers
  const qWrap = $('quests');
  qWrap.innerHTML='';
  for(const q of GAME.quests){
    const el = document.createElement('div');
    el.className='card';
    el.style.margin='8px 0 0';
    el.innerHTML = `<div class="row">
        <div class="big">${q.name}</div>
        <div>${q.done?'<span class="green">Done ‚úì</span>': ''}</div>
      </div>
      <div class="muted">Reward: +${q.reward} coins ‚Ä¢ Sticker: ${q.sticker}</div>`;
    qWrap.appendChild(el);
  }
  $('stickers').textContent = GAME.stickers.join('  ');
}

/* ===========================================================
   PRODUCTION/PROCESSING
=========================================================== */
function updateChain(dt, now){
  // 1) Mine produces resources into mine stock
  const addCoal = coalRate()*dt;
  const addOre  = oreRate()*dt;
  GAME.stock.mineCoal += addCoal;
  GAME.stock.mineOre  += addOre;
  GAME.totals.coalCollected += addCoal;

  // 2) Cart moves coal from mine -> warehouse in trips
  const spd = cartSpeed();
  const tripTime = clamp(GAME.cart.distance/spd, 1.2, 5.0); // seconds
  GAME.cart.t += dt;
  if(GAME.cart.t >= tripTime){
    GAME.cart.t = 0;
    const free = warehouseCap() - (GAME.stock.whCoal + GAME.stock.whIngots);
    const moved = Math.min(cartCarry(), GAME.stock.mineCoal, free);
    if(moved>0){ GAME.stock.mineCoal -= moved; GAME.stock.whCoal += moved; }
  }

  // 3) Crusher: ore -> chunks (rate limited & resource limited)
  const crush = Math.min(GAME.stock.mineOre, crusherRate()*dt);
  GAME.stock.mineOre -= crush;
  GAME.stock.chunks  += crush;
  $('crusherStatus').style.visibility = crush>0? 'visible':'hidden';

  // 4) Smelter: every cycle turn 1 chunk -> 1 ingot (respect warehouse cap)
  GAME.smelter.timer += dt;
  if(GAME.smelter.timer >= smeltCycle()){
    GAME.smelter.timer = 0;
    if(GAME.stock.chunks >= 1){
      const free = warehouseCap() - (GAME.stock.whCoal + GAME.stock.whIngots);
      if(free >= 1){
        GAME.stock.chunks -= 1;
        GAME.stock.whIngots += 1;
        GAME.totals.ingotsSmelted += 1;
        $('smeltStatus').style.visibility='visible';
      }else{
        $('smeltStatus').style.visibility='hidden';
      }
    }else{
      $('smeltStatus').style.visibility='hidden';
    }
  }

  checkQuests();
}

/* ===========================================================
   ISO RENDERER
=========================================================== */
const TILE_W=96, TILE_H=48, DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const canvas=$('canvas'), ctx=canvas.getContext('2d');
const CAM={x:-250,y:-200,z:1,drag:false,lx:0,ly:0};
function isoToScreen(ix,iy,iz=0){return {x:(ix-iy)*(TILE_W/2),y:(ix+iy)*(TILE_H/2)-iz};}
const stage=document.querySelector('.stage');
function resize(){
  const rect = stage.getBoundingClientRect();
  const w = Math.floor(rect.width * DPR);
  const h = Math.floor(rect.height * DPR);
  canvas.width = w; canvas.height = h;
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
}
window.addEventListener('resize', resize); resize();
canvas.addEventListener('mousedown',e=>{CAM.drag=true;CAM.lx=e.clientX;CAM.ly=e.clientY;});
window.addEventListener('mouseup',()=>CAM.drag=false);
window.addEventListener('mousemove',e=>{if(!CAM.drag)return;CAM.x+=e.clientX-CAM.lx;CAM.y+=e.clientY-CAM.ly;CAM.lx=e.clientX;CAM.ly=e.clientY;});
canvas.addEventListener('wheel', e => {
  const s = Math.exp(-e.deltaY * 0.001);
  const old = CAM.z;
  CAM.z = clamp(CAM.z * s, 0.5, 2.25);
  const r = canvas.getBoundingClientRect();
  const mx = e.clientX - (r.left + r.width / 2);
  const my = e.clientY - (r.top + r.height / 2);
  CAM.x = mx - (mx - CAM.x) * (CAM.z / old);
  CAM.y = my - (my - CAM.y) * (CAM.z / old);
}, { passive: true });

/* Decorative trees (FIX for ReferenceError) */
const trees = Array.from({length:45}, (_, i) => ({
  x: (i % 9) + 0.5,
  y: Math.floor(i / 9) + 0.5,
  s: Math.random()
}));

const buildings=[
  {id:'mine',x:6,y:4,w:3,h:3,H:42,label:'Mine',color:'#c5d4e8'},
  {id:'crusher',x:10,y:3,w:3,h:2,H:36,label:'Crusher',color:'#b7c7dd'},
  {id:'smelter',x:13,y:2,w:3,h:2,H:48,label:'Smelter',color:'#b2d6c7'},
  {id:'warehouse',x:9,y:7,w:3,h:2,H:36,label:'Warehouse',color:'#f0cfa6'},
  {id:'office',x:12,y:6,w:2,h:2,H:40,label:'HQ',color:'#e2b7cc'}
];

const tileTex=(()=>{const c=document.createElement('canvas');c.width=TILE_W;c.height=TILE_H;const g=c.getContext('2d');
  g.translate(TILE_W/2,TILE_H/2);g.beginPath();g.moveTo(0,-TILE_H/2);g.lineTo(TILE_W/2,0);g.lineTo(0,TILE_H/2);g.lineTo(-TILE_W/2,0);g.closePath();
  const grd=g.createLinearGradient(-TILE_W/2,0,TILE_W/2,0);grd.addColorStop(0,'#d7e2f1');grd.addColorStop(1,'#f3f7ff');g.fillStyle=grd;g.fill();
  g.strokeStyle='rgba(0,0,0,0.06)';g.stroke();return c;})();
function shadow(g,x,y,w,d){g.save();g.globalAlpha=.2;g.fillStyle='#000';g.beginPath();g.ellipse(x,y+8,w,d,0,0,Math.PI*2);g.fill();g.restore();}
function drawTree(g,ix,iy,t){const p=isoToScreen(ix,iy,0);shadow(g,p.x,p.y,12,6);const sway=Math.sin(t+ix*13.3+iy*7.1)*2;
  g.save();g.translate(p.x,p.y-16);
  g.fillStyle='#2e8f42';g.beginPath();g.moveTo(0,-24+sway);g.lineTo(8,-6+sway);g.lineTo(-8,-6+sway);g.closePath();g.fill();
  g.fillStyle='#206e32';g.beginPath();g.moveTo(0,-16+sway);g.lineTo(7,-2+sway);g.lineTo(-7,-2+sway);g.closePath();g.fill();
  g.fillStyle='#1a5a29';g.beginPath();g.moveTo(0,-8+sway);g.lineTo(6,2+sway);g.lineTo(-6,2+sway);g.closePath();g.fill();g.restore();}
function lighten(c,f){const n=parseInt(c.slice(1),16);let r=(n>>16)&255,g=(n>>8)&255,b=n&255;
  r=Math.min(255,Math.max(0,Math.round(r+(255-r)*f)));g=Math.min(255,Math.max(0,Math.round(g+(255-g)*f)));b=Math.min(255,Math.max(0,Math.round(b+(255-b)*f)));
  return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);} 
function darken(c,f){return lighten(c,-f);} 
function box(g,x,y,w,h,H,col){const p=[isoToScreen(x,y,H),isoToScreen(x+w,y,H),isoToScreen(x+w,y+h,H),isoToScreen(x,y+h,H)];
  const b=[isoToScreen(x,y,0),isoToScreen(x+w,y,0),isoToScreen(x+w,y+h,0),isoToScreen(x,y+h,0)];
  g.fillStyle=darken(col,.18);g.beginPath();g.moveTo(p[1].x,p[1].y);g.lineTo(b[1].x,b[1].y);g.lineTo(b[2].x,b[2].y);g.lineTo(p[2].x,p[2].y);g.closePath();g.fill();
  g.fillStyle=darken(col,.08);g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(b[0].x,b[0].y);g.lineTo(b[3].x,b[3].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill();
  g.fillStyle=lighten(col,.06);g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(p[1].x,p[1].y);g.lineTo(p[2].x,p[2].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.fill();
  g.strokeStyle='rgba(0,0,0,0.1)';g.beginPath();g.moveTo(p[0].x,p[0].y);g.lineTo(p[1].x,p[1].y);g.lineTo(p[2].x,p[2].y);g.lineTo(p[3].x,p[3].y);g.closePath();g.stroke();}
function label(g,x,y,t){g.save();g.font='12px Inter,system-ui,Arial';g.textAlign='center';g.fillStyle='rgba(0,0,0,.8)';g.fillText(t,x,y);g.restore();}
function minerSprite(g,m,t){const p=isoToScreen(m.x,m.y,0);shadow(g,p.x,p.y,10,6);g.save();g.translate(p.x,p.y-10+Math.sin(t*2+m.id.length)*1.5);
  g.fillStyle='#5b8bd4';g.fillRect(-5,-10,10,12);g.fillStyle='#f2c39b';g.beginPath();g.arc(0,-14,5,0,Math.PI*2);g.fill();
  if(m.id==='timmy'){g.fillStyle='#d7263d';g.fillRect(-6,-20,12,4);g.beginPath();g.moveTo(-6,-20);g.lineTo(0,-24);g.lineTo(6,-20);g.closePath();g.fill();}
  else{g.fillStyle='#333';g.fillRect(-6,-20,12,4);} g.restore();}
const miners=[{id:'timmy',x:6.5,y:3.5,t:Math.random(),speed:.7,carry:'coal'},
              {id:'m2',x:6.1,y:4.6,t:Math.random(),speed:.6,carry:'coal'},
              {id:'m3',x:6.8,y:3.2,t:Math.random(),speed:.65,carry:'ore'}];

function renderIso(now){
  const cx=canvas.width/(2*DPR), cy=canvas.height/(2*DPR);
  ctx.save(); ctx.translate(cx+CAM.x,cy+CAM.y); ctx.scale(CAM.z,CAM.z);
  for(let y=0;y<14;y++) for(let x=0;x<18;x++){const p=isoToScreen(x,y,0);ctx.drawImage(tileTex,p.x-TILE_W/2,p.y-TILE_H/2);} 
  // draw decorative trees
  for(const t of trees){drawTree(ctx,t.x,t.y,now*0.001+t.s);} 
  // Buildings
  for(const b of [...buildings].sort((a,b)=>(a.x+a.y)-(b.x+b.y))){
    box(ctx,b.x,b.y,b.w,b.h,b.H,b.color);
    const c=isoToScreen(b.x+b.w/2,b.y+b.h/2,b.H+12);label(ctx,c.x,c.y,b.label);
  }
  // Miners wander
  for(const m of miners){m.t += 0.02; const r=0.55; const tgt=m.carry==='ore'?{x:6.8,y:3.3}:{x:6.2,y:4.6};
    m.x=tgt.x+Math.cos(m.t+m.speed*2)*r; m.y=tgt.y+Math.sin(m.t+m.speed*2)*r; minerSprite(ctx,m,now*0.001);} 
  ctx.restore();
}

/* ===========================================================
   LOOP + SELF-TESTS
=========================================================== */
let last = performance.now();
function tick(now){
  const dt = Math.min(0.05,(now-last)/1000); last = now;
  updateChain(dt, now);
  refreshUI(now);
  ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
  renderIso(now);
  requestAnimationFrame(tick);
}

// Lightweight runtime checks ("tests") to catch missing refs quickly
(function selfTests(){
  console.assert(!!document.getElementById('canvas'), 'Canvas element not found');
  console.assert(Array.isArray(trees) && trees.length>0, 'trees array should exist and be non-empty');
  console.assert(Array.isArray(buildings) && buildings.length>0, 'buildings should exist');
  console.assert(typeof renderIso==='function', 'renderIso should be defined');
})();

requestAnimationFrame(tick);
</script>
</body>
</html>
